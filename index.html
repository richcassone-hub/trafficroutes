<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Traffic Travel-Time Board</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .app { display: flex; height: 100vh; width: 100vw; overflow: hidden; }

    .left {
      width: 340px;
      min-width: 260px;
      max-width: 60vw;      border-right: none;
padding: 12px;
      box-sizing: border-box;
      overflow: auto;
    }

    

    .middle {
      width: 360px;
      min-width: 260px;
      max-width: 60vw;
      border-right: 1px solid rgba(128,128,128,0.35);
      padding: 12px;
      box-sizing: border-box;
      overflow: auto;
    }
.splitter {
      width: 8px;
      cursor: col-resize;
      background: rgba(128,128,128,0.12);
      border-right: 1px solid rgba(128,128,128,0.25);
      border-left: 1px solid rgba(128,128,128,0.25);
      user-select: none;
      touch-action: none;
    }
    .splitter:hover { background: rgba(128,128,128,0.18); }

    .right { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    .toolbar {
      display: flex; gap: 8px; align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(128,128,128,0.35);
      flex-wrap: wrap;
    }
    .toolbar .title { font-weight: 700; }

    .frameWrap { position: relative; flex: 1; min-height: 0; }
    iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: 0; }

    /* Collapsible blocks */
    .collapse {
      border: 1px solid rgba(128,128,128,0.35);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .collapse-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 10px;
      cursor: pointer;
      user-select: none;
      background: rgba(128,128,128,0.10);
    }
    .collapse-header .label { font-weight: 700; }
    .collapse-header .chev {
      font-size: 12px;
      opacity: 0.8;
      padding: 4px 10px;
      border: 1px solid rgba(128,128,128,0.35);
      border-radius: 999px;
    }
    
    /* Buttons styled like Show/Hide pills */
    .chevBtn{
      font-size: 12px;
      opacity: 0.8;
      padding: 4px 10px;
      border: 1px solid rgba(128,128,128,0.35);
      border-radius: 999px;
      background: transparent;
      color: inherit;
      line-height: 1;
      white-space: nowrap;
    }
    .chevBtn:hover{ background: rgba(128,128,128,0.10); }
.collapse-body {
      padding: 10px;
      background: rgba(128,128,128,0.12);
      display: none;
    }
    .collapse.open .collapse-body { display: block; }

    label { display: block; font-size: 12px; opacity: 0.85; margin-top: 10px; }
    input, select, textarea, button { font: inherit; }
    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid rgba(128,128,128,0.4);
      border-radius: 10px;
      background: transparent;
      color: inherit;
      box-sizing: border-box;
    }
    textarea { resize: vertical; }

    /* Small, rounded buttons */
    button {
      cursor: pointer;
      padding: 6px 10px;
      border: 1px solid rgba(128,128,128,0.4);
      border-radius: 999px;
      background: transparent;
      color: inherit;
      line-height: 1;
    }
    .toolbar button { padding: 6px 10px; border-radius: 999px; }

    .row { display:flex; gap:8px; align-items: center; }
    .row > * { flex: 1; }
    .hint { font-size: 12px; opacity: 0.75; margin-top: 10px; line-height: 1.35; }
    .small { font-size: 12px; opacity: 0.85; }
    .kicker { display:flex; align-items: baseline; justify-content: space-between; gap:10px; margin-top: 10px; }
    .section-title { font-weight: 700; margin: 16px 0 6px; }

    .filters { display: flex; flex-wrap: wrap; gap: 6px; margin: 10px 0; }
    .filters button.active {
      border-color: rgba(128,128,128,0.85);
      font-weight: 700;
      opacity: 1;
    }

    .list { display: flex; flex-direction: column; gap: 8px; }
    .card {
      border: 1px solid rgba(128,128,128,0.35);
      border-radius: 12px;
      padding: 10px;
      background: rgba(0,0,0,0);
    }
    .card .top { display:flex; justify-content: space-between; gap:10px; align-items: start; }
    .card .name { font-weight: 700; font-size: 13px; line-height: 1.25; }
    .card .meta { font-size: 12px; opacity: 0.8; margin-top: 4px; line-height: 1.3; }

    .card.clickable { cursor: pointer; }

    /* Drag handle for reordering routes (card itself is clickable) */
    .card .dragHandle{
      flex: 0 0 auto;
      width: 18px;
      border-radius: 10px;
      background: rgba(128,128,128,0.18);
      border: 1px solid rgba(128,128,128,0.30);
      margin-right: 8px;
      align-self: stretch;
      cursor: grab;
      position: relative;
      user-select: none;
    }
    .card .dragHandle:active{ cursor: grabbing; }
    .card .dragHandle::before{
      content: "⋮⋮";
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      opacity: 0.75;
      letter-spacing: -2px;
      transform: translateX(-1px);
    }
    .card[draggable="true"] { cursor: grab; }
    .card.dragging { opacity: 0.55; }
    .drop-hint { outline: 2px dashed rgba(128,128,128,0.6); outline-offset: 2px; }

    /* Red X delete */
    .danger-x {
      padding: 6px 10px;
      border-radius: 999px;
      border-color: rgba(255,80,80,0.75);
      color: rgb(255,80,80);
      font-weight: 800;
    }

    .reading-time { margin-top: 8px; font-size: 12px; opacity: 0.85; }

    /* Script: reading line + Set WPM on same row */
    .script-meta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-top: 8px;
    }
    .script-meta .reading-time{
      margin-top: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Card actions: Show / Reverse / X on one line, tighter */
    .card-actions{
      display:flex;
      gap:4px;
      flex-wrap: nowrap;
      align-items:center;
      white-space: nowrap;
    }

    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }
    .modal-backdrop.open { display: flex; }
    .modal {
      width: min(680px, 96vw);
      max-height: 86vh;
      overflow: hidden;
      border: 1px solid rgba(128,128,128,0.35);
      border-radius: 14px;
      background: rgba(24,24,24,0.92);
      color: inherit;
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
      padding: 14px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    .modal h3 { margin: 0 0 10px 0; }
    .modal .bar { display:flex; gap:8px; justify-content: flex-end; margin-top: 12px; flex-wrap: wrap; }
    .modal .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .modal .hr { height: 1px; background: rgba(128,128,128,0.30); margin: 12px 0; }

    .phonesModalHeader{
      position: sticky;
      top: 0;
      z-index: 5;
      background: rgba(24,24,24,0.98);
      padding: 0 0 8px 0;
    }
    .phonesModalHeader h3{ padding-right: 44px; }
    .phonesModalHeader .small{ padding-right: 44px; }
    .phonesModal{ position: relative; }
    .phonesModalBody{
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }
    .phonesTableWrap{
      height: 100%;
      overflow: auto;
      border-radius: 10px;
    }

    .phoneIcon{
      width: 18px;
      height: 18px;
      display: block;
    }
    #phonesBtn{
      width: 40px;
      height: 32px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .modal-x{
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(128,128,128,0.45);
      background: rgba(128,128,128,0.10);
      color: inherit;
      font-weight: 800;
      line-height: 1;
    }
    .modal-x:hover{ background: rgba(128,128,128,0.18); }

    .phonesTable{
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      line-height: 1.2;
    }
    .phonesTable thead th{
      position: sticky;
      top: 0;
      background: rgba(24,24,24,0.98);
      z-index: 2;
    }
    .phonesTable th, .phonesTable td{
      padding: 6px 8px;
      border-bottom: 1px solid rgba(128,128,128,0.25);
      vertical-align: middle;
    }
    .phonesTable tbody tr:hover{
      background: rgba(128,128,128,0.10);
    }
    .callBtn{
      width: 30px;
      height: 26px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      border: 1px solid rgba(128,128,128,0.45);
      background: rgba(128,128,128,0.10);
      color: inherit;
      cursor: pointer;
    }
    .callBtn .phoneIcon{ width: 16px; height: 16px; }
    .callBtn:hover{ background: rgba(128,128,128,0.18); }

    .region-row { display:flex; gap:8px; align-items:center; }
    .region-row .pill { font-size: 12px; opacity: 0.9; padding: 4px 8px; border: 1px solid rgba(128,128,128,0.35); border-radius: 999px; }
    .region-row button.danger { border-color: rgba(255,80,80,0.75); color: rgb(255,80,80); }

    /* CAD active shaded */
    .toolbar button.active-toggle {
      border-color: rgba(128,128,128,0.85);
      font-weight: 700;
      background: rgba(128,128,128,0.22);
    }

    .add-actions {
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
  
    /* Stopwatch (left pane, pinned) */
    .stopwatchBar{
      position: sticky;
      top: 0;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid rgba(128,128,128,0.35);
      border-radius: 12px;
      background: rgba(50,50,50,1);
    }
    .stopwatchDisplay{
      font-weight: 800;
      font-size: clamp(48px, 9vw, 48px);
      line-height: 1;
      letter-spacing: 0.5px;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }
    .stopwatchBtns {
  		display: flex;
  		flex-direction: column;
  		gap: 8px;
  		align-items: stretch;
	}

  

    /* Pronunciations page */
    .pronPage{
      position:absolute;
      inset:0;
      padding: 12px;
      box-sizing: border-box;
      overflow: auto;
      display:none;
      background: rgba(0,0,0,0);
    }
    .pronPage .kicker{ margin-top: 0; }
    .pronToolbar{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 10px;
    }
    .pronToolbar input{
      width: auto;
      flex: 1 1 220px;
    }
    .pronToolbar .fixedBtn{ flex: 0 0 auto; }
    .pronColumns{
      column-width: 260px;
      column-gap: 10px;
    }
    .pronItem{
      break-inside: avoid;
      border: 1px solid rgba(128,128,128,0.35);
      border-radius: 12px;
      padding: 10px;
      margin: 0 0 10px 0;
      background: rgba(0,0,0,0);
      display:flex;
      gap:10px;
      align-items: start;
    }
    .pronItem .txt{ flex: 1; min-width: 0; }
    .pronItem .term{ font-weight: 800; font-size: 13px; line-height: 1.2; }
    .pronItem .say{ font-size: 12px; opacity: 0.85; margin-top: 4px; line-height: 1.25; }
    .pronItem .actions{ flex: 0 0 auto; }


    /* Fullscreen */
    .app:fullscreen { width: 100vw; height: 100vh; overflow: hidden; }
    </style>
</head>
<body>
  <div class="app">
    <aside class="left" id="leftPane">

      <!-- Stopwatch (pinned) -->
      <div class="stopwatchBar" id="stopwatchBar" aria-label="Stopwatch">
        <div class="stopwatchDisplay" id="stopwatchDisplay">00:00</div>
        <div class="stopwatchBtns">
          <button type="button" id="stopwatchToggleBtn">Start</button>
          <button type="button" id="stopwatchResetBtn">Reset</button>
        </div>
      </div>

      <!-- Script pane -->
      <div class="collapse" id="scriptCollapse">
        <div class="collapse-header" id="scriptHeader" role="button" tabindex="0" aria-expanded="false">
          <div class="label">Script</div>
          <div class="chev" id="scriptChev">Show</div>
        </div>
        <div class="collapse-body">
          <label for="scriptText">Script</label>
          <textarea id="scriptText" rows="10" placeholder="Type script here..."></textarea>

          <div class="script-meta">
            <div class="reading-time" id="scriptReadingLine">WPM: 180 | Script words: 0 | Reading time: 0:00</div>
            <button type="button" id="setWpmBtn" class="chevBtn">Set WPM</button>
          </div>

          <label for="lockoutText">Lock-out</label>
          <textarea id="lockoutText" rows="2" placeholder="Lock-out..."></textarea>

          <div class="reading-time" id="lockoutReadingLine">Lockout words: 0 | Reading time: 0:00</div>
        </div>
      </div>

      <!-- Script pane (2) -->
      <div class="collapse" id="scriptCollapse2">
        <div class="collapse-header" id="scriptHeader2" role="button" tabindex="0" aria-expanded="false">
          <div class="label">Script 2</div>
          <div class="chev" id="scriptChev2">Show</div>
        </div>
        <div class="collapse-body">
          <label for="scriptText2">Script</label>
          <textarea id="scriptText2" rows="10" placeholder="Type script here..."></textarea>

          <div class="script-meta">
            <div class="reading-time" id="scriptReadingLine2">WPM: 180 | Script words: 0 | Reading time: 0:00</div>
            <button type="button" id="setWpmBtn2" class="chevBtn">Set WPM</button>
          </div>

          <label for="lockoutText2">Lock-out</label>
          <textarea id="lockoutText2" rows="2" placeholder="Lock-out..."></textarea>

          <div class="reading-time" id="lockoutReadingLine2">Lockout words: 0 | Reading time: 0:00</div>
        </div>
      </div>

      

    </aside>

    <div class="splitter" id="splitter" title="Drag to resize"></div>

    <aside class="middle" id="middlePane">
      
      <!-- Add Route pane -->
      <div class="collapse" id="addCollapse">
        <div class="collapse-header" id="collapseHeader" role="button" tabindex="0" aria-expanded="false">
          <div class="label">Add Route</div>
          <div class="chev" id="collapseChev">Show</div>
        </div>
        <div class="collapse-body">
          <form id="routeForm">
            <label for="name">Name</label>
            <input id="name" name="name" required placeholder="SB 101 – Sherman Oaks to Downtown" />

            <div class="row" style="gap:10px;">
              <div>
                <label for="region">Region</label>
                <select id="region" name="region"></select>
              </div>
              <div style="flex:0 0 auto; align-self: end;">
                <button type="button" id="manageRegionsBtn" title="Add or delete regions">Manage Regions</button>
              </div>
            </div>

            <label for="origin">Origin (place or lat,lng)</label>
            <input id="origin" name="origin" required placeholder="Sherman Oaks, CA" />

            <label for="destination">Destination (place or lat,lng)</label>
            <input id="destination" name="destination" required placeholder="Downtown Los Angeles, CA" />

            <div style="display:flex; gap:8px; margin-top: 12px;">
              <button type="submit" style="flex:1; border-radius: 12px;">Add</button>
              <button type="button" id="tryRouteBtn" title="Preview this route on the map" style="border-radius: 12px;">Try it</button>
              <button type="button" id="resetBtn" title="Reset form" style="border-radius: 12px;">Reset</button>
            </div>

            <div class="add-actions">
              <button type="button" id="exportRoutesBtn">Export Routes</button>
              <button type="button" id="importRoutesBtn">Import Routes</button>
              <button type="button" id="loadDefaultsBtn">Load Defaults</button>
              <input type="file" id="importFile" accept=".xml,text/xml,application/xml" style="display:none" />
            </div>

            <div class="hint">
              Defaults live in this file (no external files; no server required).
            </div>
          </form>
        </div>
      </div>


      <div class="kicker">
        <div class="section-title" style="margin: 0;">Routes</div>
        <div class="small" id="countLabel"></div>
      </div>

      <div class="filters" id="filterBar"></div>
      <div id="routeList" class="list"></div>
    </aside>

    <div class="splitter" id="splitter2" title="Drag to resize"></div>

<main class="right">
      <div class="toolbar">
        <button id="middleToggleBtn" type="button">←</button>
        <button id="reverseCurrentBtn" disabled>Reverse</button>
        <button id="openExternalBtn" disabled>Tab</button>
        <button id="camsBtn" type="button">Cams</button>
        <button id="cadBtn" type="button">CAD</button>
        <button id="quickmapBtn" type="button">QuickMap</button>
        <button id="pronBtn" type="button" title="Pronunciations">Pron</button>
        <button id="phonesBtn" type="button" title="CHP/TMC phone numbers" aria-label="Phone numbers">
<svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" class="phoneIconSvg">
  <path fill="#3ccf6e" d="M6.62 10.79c1.44 2.87 3.72 5.15 6.59 6.59l2.2-2.2
  c.27-.27.67-.36 1.02-.26 1.12.37 2.33.57 3.57.57
  .55 0 1 .45 1 1V20c0 .55-.45 1-1 1C10.07 21 3 13.93 3 5
  c0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1
  0 1.25.2 2.45.57 3.57.11.35.02.74-.25 1.01l-2.2 2.21z"/>
</svg>
</button>
        <div style="flex:1;"></div>
        <div id="currentLabel" class="small" style="margin-left:10px; opacity:0.8;"></div>
        <button id="fullscreenBtn" type="button">↕</button>
      </div>

      <div class="frameWrap">
        <iframe id="gmapsFrame" title="Google Maps" style="display:block;"></iframe>
        <iframe id="cadFrame" title="CAD" style="display:none;"></iframe>
        <iframe id="camsFrame" title="Cams" style="display:none;"></iframe>
        <iframe id="quickmapFrame" title="QuickMap" style="display:none;"></iframe>

        <div id="pronPage" class="pronPage" aria-label="Pronunciations">
          <div class="kicker">
            <div class="section-title" style="margin: 0;">Pronunciation</div>
            <div class="small" id="pronCountLabel"></div>
          </div>

          <div class="filters" id="pronFilterBar"></div>

          <div class="pronToolbar">
            <input id="pronTerm" placeholder="Place (e.g., Cahuenga)" />
            <input id="pronSay" placeholder="Pronunciation (e.g., kuh-WENG-guh)" />
            <button type="button" id="pronAddBtn" class="fixedBtn">Add</button>
            <button type="button" id="pronExportBtn" class="fixedBtn">Export</button>
            <button type="button" id="pronImportBtn" class="fixedBtn">Import</button>
            <input type="file" id="pronImportFile" accept=".json,application/json" style="display:none" />
          </div>

          <div class="hint">Tip: Keep the spelling you want to see on-air. Use hyphens for beats (e.g., "SAN buhr-DEE-no").</div>

          <div id="pronList" class="pronColumns" style="margin-top:10px;"></div>
        </div>

 
      

     </div>
    </main>
  </div>

  <!-- Modal: WPM -->
  <div class="modal-backdrop" id="wpmModal">
    <div class="modal">
      <h3>Words per minute</h3>
      <div class="small">Used for reading-time estimates.</div>
      <div class="hr"></div>
      <label for="wpmInput">WPM</label>
      <input id="wpmInput" inputmode="numeric" placeholder="180" />
      <div class="bar">
        <button type="button" id="wpmCancelBtn">Cancel</button>
        <button type="button" id="wpmSaveBtn">Save</button>
      </div>
    </div>
  </div>

  <!-- Modal: Regions -->
  <div class="modal-backdrop" id="regionsModal">
    <div class="modal">
      <h3>Manage regions</h3>
      <div class="small">Add or delete regions. Deleting a region deletes all routes in that region.</div>
      <div class="hr"></div>

      <div id="regionsList"></div>

      <div class="hr"></div>

      <div class="grid">
        <div>
          <label for="newRegionId">Code (short)</label>
          <input id="newRegionId" placeholder="e.g., OC" />
          <div class="small">Use a short code like LA, Ventura, IE, SD, OC.</div>
        </div>
        <div>
          <label for="newRegionLabel">Name</label>
          <input id="newRegionLabel" placeholder="e.g., Orange County" />
        </div>
      </div>

      <div class="bar" style="justify-content: space-between;">
        <button type="button" id="regionsCloseBtn">Close</button>
        <div style="display:flex; gap:8px; flex-wrap: wrap;">
          <button type="button" id="regionsAddBtn">Add Region</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Modal: Phones -->
  <div class="modal-backdrop" id="phonesModal" aria-hidden="true">
    <div class="modal phonesModal" role="dialog" aria-modal="true" aria-label="CHP/TMC phone numbers">
      <div class="phonesModalHeader">
        <button type="button" class="modal-x" id="phonesCloseX" aria-label="Close">✕</button>
        <h3>CHP/TMC phone numbers</h3>
        <div class="small">Tap the phone icon to call (works on devices that support tel: links).</div>
        <div class="hr"></div>
      </div>

      <div class="phonesModalBody">
        <div class="phonesTableWrap">
          <table class="phonesTable" aria-label="Phone numbers table">
            <thead>
              <tr>
                <th style="text-align:left;">Name</th>
                <th style="text-align:left;">Phone</th>
                <th style="width:56px; text-align:center;">Call</th>
              </tr>
            </thead>
            <tbody id="phonesTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
    const STORAGE_KEY = "traffic_board_routes_v11";
    const LEFT_WIDTH_KEY = "traffic_board_left_width_v1";
    const MIDDLE_WIDTH_KEY = "traffic_board_middle_width_v1";
    const MIDDLE_COLLAPSED_KEY = "traffic_board_middle_collapsed_v1";

    const SCRIPT_KEY = "traffic_board_script_v1";
    const LOCKOUT_KEY = "traffic_board_lockout_v1";

    const SCRIPT2_KEY = "traffic_board_script2_v1";
    const LOCKOUT2_KEY = "traffic_board_lockout2_v1";
    const WPM_KEY = "traffic_board_wpm_v1";

    const REGIONS_KEY = "traffic_board_regions_v1";
    const PRON_KEY = "traffic_board_pronunciations_v1";

    const CAD_BASE = "/mycad.html";
    const QUICKMAP_URL = "https://quickmap.dot.ca.gov/QM/maps/traffic/mwebview.html?z=11&ll=34.04,-118.25";
    const CAMS_URL = "https://cwwp2.dot.ca.gov/vm/iframemap.htm?long=-118.2437&lat=34.0522&zoom=24";

    const STOPWATCH_KEY = "traffic_board_stopwatch_v1"; // optional persistence (elapsed ms only)

    const stopwatchDisplay = document.getElementById("stopwatchDisplay");
    const stopwatchToggleBtn = document.getElementById("stopwatchToggleBtn");
    const stopwatchResetBtn = document.getElementById("stopwatchResetBtn");

    let swRunning = false;
    let swStart = 0;        // performance.now() when started
    let swElapsed = loadStopwatchElapsed(); // ms accumulated
    let swTimer = null;

    function loadStopwatchElapsed() {
      try {
        const raw = localStorage.getItem(STOPWATCH_KEY);
        const n = Number(raw);
        return Number.isFinite(n) && n >= 0 ? n : 0;
      } catch {
        return 0;
      }
    }
    function saveStopwatchElapsed(ms) {
      try { localStorage.setItem(STOPWATCH_KEY, String(Math.max(0, Math.round(ms)))); } catch {}
    }

    function pad2(n) { return String(n).padStart(2, "0"); }
    function formatStopwatch(ms) {
      const totalSec = Math.floor(Math.max(0, ms) / 1000);
      const mm = Math.floor(totalSec / 60);
      const ss = totalSec % 60;
      return `${pad2(mm)}:${pad2(ss)}`;
    }
    function renderStopwatch() {
      stopwatchDisplay.textContent = formatStopwatch(swElapsed + (swRunning ? (performance.now() - swStart) : 0));
    }

    function stopStopwatch() {
      if (!swRunning) return;
      swElapsed = swElapsed + (performance.now() - swStart);
      swRunning = false;
      swStart = 0;
      if (swTimer) { clearInterval(swTimer); swTimer = null; }
      stopwatchToggleBtn.textContent = "Start";
      saveStopwatchElapsed(swElapsed);
      renderStopwatch();
    }

    function startStopwatch() {
      if (swRunning) return;
      swRunning = true;
      swStart = performance.now();
      stopwatchToggleBtn.textContent = "Stop";
      if (swTimer) clearInterval(swTimer);
      swTimer = setInterval(() => {
        renderStopwatch();
      }, 200);
      renderStopwatch();
    }

    stopwatchToggleBtn.addEventListener("click", () => {
      if (swRunning) stopStopwatch();
      else startStopwatch();
    });

    stopwatchResetBtn.addEventListener("click", () => {
  if (swRunning) {
    stopStopwatch();
  }

  swElapsed = 0;
  saveStopwatchElapsed(swElapsed);
  renderStopwatch();
});

    // Initial paint
    renderStopwatch();

    // ---------- DEFAULTS LIVE HERE (single-file) ----------
    function defaultRegions() {
      return [
        { id: "LA", label: "Los Angeles" },
        { id: "Ventura", label: "Ventura" },
        { id: "IE", label: "Inland Empire" },
        { id: "SD", label: "San Diego" },
      ];
    }

    function defaultRoutes() {
      return [
        // Los Angeles County (10)
        { id: crypto.randomUUID(), region: "LA", name: "SB 101 – Sherman Oaks to Downtown", origin: "Sherman Oaks, CA", destination: "Downtown Los Angeles, CA" },
        { id: crypto.randomUUID(), region: "LA", name: "SB 405 – Sherman Oaks to West LA", origin: "Sherman Oaks, CA", destination: "West Los Angeles, CA" },
        { id: crypto.randomUUID(), region: "LA", name: "EB 10 – West LA to Downtown", origin: "West Los Angeles, CA", destination: "Downtown Los Angeles, CA" },
        { id: crypto.randomUUID(), region: "LA", name: "EB 105 – Hawthorne to Norwalk", origin: "Hawthorne, CA", destination: "Norwalk, CA" },
        { id: crypto.randomUUID(), region: "LA", name: "NB 110 – Long Beach to Downtown", origin: "Long Beach, CA", destination: "Downtown Los Angeles, CA" },
        { id: crypto.randomUUID(), region: "LA", name: "NB 710 – Long Beach to East LA", origin: "Long Beach, CA", destination: "East Los Angeles, CA" },
        { id: crypto.randomUUID(), region: "LA", name: "NB 5 – Santa Fe Springs to Downtown", origin: "Santa Fe Springs, CA", destination: "Downtown Los Angeles, CA" },
        { id: crypto.randomUUID(), region: "LA", name: "SB 5 – Sylmar to Downtown", origin: "Sylmar, CA", destination: "Downtown Los Angeles, CA" },
        { id: crypto.randomUUID(), region: "LA", name: "NB 605 – Santa Fe Springs to Duarte", origin: "Santa Fe Springs, CA", destination: "Duarte, CA" },
        { id: crypto.randomUUID(), region: "LA", name: "WB 210 – San Dimas to Pasadena", origin: "San Dimas, CA", destination: "Pasadena, CA" },

        // Ventura County (6)
        { id: crypto.randomUUID(), region: "Ventura", name: "SB 101 – Oxnard to Thousand Oaks", origin: "Oxnard, CA", destination: "Thousand Oaks, CA" },
        { id: crypto.randomUUID(), region: "Ventura", name: "NB 101 – Oxnard to Santa Barbara", origin: "Oxnard, CA", destination: "Santa Barbara, CA" },
        { id: crypto.randomUUID(), region: "Ventura", name: "EB 118 – Saticoy to Moorpark", origin: "Saticoy, CA", destination: "Moorpark, CA" },
        { id: crypto.randomUUID(), region: "Ventura", name: "EB 118 – Moorpark to Simi Valley", origin: "Moorpark, CA", destination: "Simi Valley, CA" },
        { id: crypto.randomUUID(), region: "Ventura", name: "WB 126 – Fillmore to Ventura", origin: "Fillmore, CA", destination: "Ventura, CA" },
        { id: crypto.randomUUID(), region: "Ventura", name: "EB 150 – Santa Paula to Ojai", origin: "Santa Paula, CA", destination: "Ojai, CA" },

        // Inland Empire (8)
        { id: crypto.randomUUID(), region: "IE", name: "SB 15 – Cajon Pass to Fontana", origin: "Cajon Pass, CA", destination: "Fontana, CA" },
        { id: crypto.randomUUID(), region: "IE", name: "SB 15 – Fontana to Corona", origin: "Fontana, CA", destination: "Corona, CA" },
        { id: crypto.randomUUID(), region: "IE", name: "EB 210 – Rancho Cucamonga to San Bernardino", origin: "Rancho Cucamonga, CA", destination: "San Bernardino, CA" },
        { id: crypto.randomUUID(), region: "IE", name: "EB 10 – Ontario to San Bernardino", origin: "Ontario, CA", destination: "San Bernardino, CA" },
        { id: crypto.randomUUID(), region: "IE", name: "WB 91 – Riverside to Orange County", origin: "Riverside, CA", destination: "Orange County, CA" },
        { id: crypto.randomUUID(), region: "IE", name: "WB 60 – Riverside to Chino", origin: "Riverside, CA", destination: "Chino, CA" },
        { id: crypto.randomUUID(), region: "IE", name: "NB 215 – Riverside to San Bernardino", origin: "Riverside, CA", destination: "San Bernardino, CA" },
        { id: crypto.randomUUID(), region: "IE", name: "WB 10 – Redlands to the LA County line", origin: "Redlands, CA", destination: "Los Angeles County, CA" },

        // San Diego County (8)
        { id: crypto.randomUUID(), region: "SD", name: "SB 5 – Oceanside to Downtown San Diego", origin: "Oceanside, CA", destination: "Downtown San Diego, CA" },
        { id: crypto.randomUUID(), region: "SD", name: "SB 15 – Escondido to Mission Valley", origin: "Escondido, CA", destination: "Mission Valley, San Diego, CA" },
        { id: crypto.randomUUID(), region: "SD", name: "SB 805 – Carlsbad to Downtown San Diego", origin: "Carlsbad, CA", destination: "Downtown San Diego, CA" },
        { id: crypto.randomUUID(), region: "SD", name: "EB 8 – Ocean Beach area to La Mesa", origin: "Ocean Beach, San Diego, CA", destination: "La Mesa, CA" },
        { id: crypto.randomUUID(), region: "SD", name: "SB 125 – La Mesa to Chula Vista", origin: "La Mesa, CA", destination: "Chula Vista, CA" },
        { id: crypto.randomUUID(), region: "SD", name: "EB 94 – Downtown San Diego to Spring Valley", origin: "Downtown San Diego, CA", destination: "Spring Valley, CA" },
        { id: crypto.randomUUID(), region: "SD", name: "EB 78 – Oceanside to Escondido", origin: "Oceanside, CA", destination: "Escondido, CA" },
        { id: crypto.randomUUID(), region: "SD", name: "EB 76 – Fallbrook to Oceanside", origin: "Fallbrook, CA", destination: "Oceanside, CA" },
      ];
    }
    // -----------------------------------------------------

    const routeForm = document.getElementById("routeForm");
    const routeListEl = document.getElementById("routeList");
    const currentLabel = document.getElementById("currentLabel");
    const openExternalBtn = document.getElementById("openExternalBtn");
    const reverseCurrentBtn = document.getElementById("reverseCurrentBtn");
    const resetBtn = document.getElementById("resetBtn");
    const tryRouteBtn = document.getElementById("tryRouteBtn");
    const filterBar = document.getElementById("filterBar");
    const countLabel = document.getElementById("countLabel");

    const exportRoutesBtn = document.getElementById("exportRoutesBtn");
    const importRoutesBtn = document.getElementById("importRoutesBtn");
    const loadDefaultsBtn = document.getElementById("loadDefaultsBtn");
    const importFile = document.getElementById("importFile");

    const leftPane = document.getElementById("leftPane");
    const middlePane = document.getElementById("middlePane");
    const splitter = document.getElementById("splitter");
    const splitter2 = document.getElementById("splitter2");

    function loadMiddleCollapsed() {
      try { return localStorage.getItem(MIDDLE_COLLAPSED_KEY) === "1"; } catch { return false; }
    }
    function saveMiddleCollapsed(v) {
      try { localStorage.setItem(MIDDLE_COLLAPSED_KEY, v ? "1" : "0"); } catch {}
    }
    function setMiddleCollapsed(collapsed) {
      middleCollapsed = !!collapsed;

      // Hide/show pane + its splitter
      middlePane.style.display = middleCollapsed ? "none" : "block";
      splitter2.style.display = middleCollapsed ? "none" : "block";

      if (middleToggleBtn) {
        middleToggleBtn.classList.toggle("active-toggle", middleCollapsed);
        middleToggleBtn.textContent = middleCollapsed ? "→" : "←";
        middleToggleBtn.title = middleCollapsed ? "Show routes pane" : "Hide routes pane";
      }

      // When restoring, re-apply saved width if any
      if (!middleCollapsed) {
        const saved = loadPaneWidth(MIDDLE_WIDTH_KEY);
        if (saved) middlePane.style.width = `${saved}px`;
        else middlePane.style.width = "360px";
      }

      saveMiddleCollapsed(middleCollapsed);
    }


    const addCollapse = document.getElementById("addCollapse");
    const collapseHeader = document.getElementById("collapseHeader");
    const collapseChev = document.getElementById("collapseChev");

    const scriptCollapse = document.getElementById("scriptCollapse");
    const scriptHeader = document.getElementById("scriptHeader");
    const scriptChev = document.getElementById("scriptChev");
    const scriptText = document.getElementById("scriptText");
    const lockoutText = document.getElementById("lockoutText");
    const scriptReadingLine = document.getElementById("scriptReadingLine");
    const lockoutReadingLine = document.getElementById("lockoutReadingLine");
    const setWpmBtn = document.getElementById("setWpmBtn");

    const scriptCollapse2 = document.getElementById("scriptCollapse2");
    const scriptHeader2 = document.getElementById("scriptHeader2");
    const scriptChev2 = document.getElementById("scriptChev2");
    const scriptText2 = document.getElementById("scriptText2");
    const lockoutText2 = document.getElementById("lockoutText2");
    const scriptReadingLine2 = document.getElementById("scriptReadingLine2");
    const lockoutReadingLine2 = document.getElementById("lockoutReadingLine2");
    const setWpmBtn2 = document.getElementById("setWpmBtn2");

    const wpmModal = document.getElementById("wpmModal");
    const wpmInput = document.getElementById("wpmInput");
    const wpmCancelBtn = document.getElementById("wpmCancelBtn");
    const wpmSaveBtn = document.getElementById("wpmSaveBtn");

    const regionsModal = document.getElementById("regionsModal");
    const manageRegionsBtn = document.getElementById("manageRegionsBtn");
    const regionsCloseBtn = document.getElementById("regionsCloseBtn");
    const regionsAddBtn = document.getElementById("regionsAddBtn");
    const regionsList = document.getElementById("regionsList");
    const newRegionId = document.getElementById("newRegionId");
    const newRegionLabel = document.getElementById("newRegionLabel");

    const phonesModal = document.getElementById("phonesModal");
    const phonesTbody = document.getElementById("phonesTbody");
    const phonesCloseX = document.getElementById("phonesCloseX");

    const cadBtn = document.getElementById("cadBtn");
    const quickmapBtn = document.getElementById("quickmapBtn");
    const pronBtn = document.getElementById("pronBtn");
    const phonesBtn = document.getElementById("phonesBtn");
    const middleToggleBtn = document.getElementById("middleToggleBtn");

    const camsBtn = document.getElementById("camsBtn");

    const gmapsFrame = document.getElementById("gmapsFrame");
    const cadFrame = document.getElementById("cadFrame");
    const quickmapFrame = document.getElementById("quickmapFrame");


    const pronPage = document.getElementById("pronPage");
    const pronFilterBar = document.getElementById("pronFilterBar");
    const pronListEl = document.getElementById("pronList");
    const pronCountLabel = document.getElementById("pronCountLabel");
    const pronTerm = document.getElementById("pronTerm");
    const pronSay = document.getElementById("pronSay");
    const pronAddBtn = document.getElementById("pronAddBtn");

    const camsFrame = document.getElementById("camsFrame");

    let regions = loadRegions();
    let routes = loadRoutes() ?? defaultRoutes();

    let currentRoute = null;
    let currentReversed = false;
    let activeFilter = "ALL";

    let wpm = loadWpm();

    // CAD persistence: separate iframe stays loaded (hidden via display none).
    let cadVisible = false;
    let cadInitialized = false;
    let quickmapVisible = false;
    let quickmapInitialized = false;

    let camsVisible = false;
    let camsInitialized = false;

    let pronVisible = false;
    let activePronRegion = "LA";
    let pronunciations = loadPronunciations();

    let middleCollapsed = false;

    /* ---------- Storage: basic helpers ---------- */
    function loadText(key, fallback = "") {
      try {
        const v = localStorage.getItem(key);
        return v == null ? fallback : v;
      } catch {
        return fallback;
      }
    }
    function saveText(key, value) {
      localStorage.setItem(key, value);
    }

    /* ---------- Storage: Routes ---------- */
    function loadRoutes() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return null;
        return parsed;
      } catch {
        return null;
      }
    }
    function saveRoutes() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(routes));
    }

    /* ---------- Storage: Regions ---------- */
    function loadRegions() {
      try {
        const raw = localStorage.getItem(REGIONS_KEY);
        if (!raw) return defaultRegions();
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return defaultRegions();
        const cleaned = parsed
          .filter(r => r && typeof r.id === "string" && typeof r.label === "string")
          .map(r => ({ id: r.id.trim(), label: r.label.trim() }))
          .filter(r => r.id && r.label);
        return cleaned.length ? cleaned : defaultRegions();
      } catch {
        return defaultRegions();
      }
    }
    function saveRegions() {
      localStorage.setItem(REGIONS_KEY, JSON.stringify(regions));
    }


    /* ---------- Storage: Pronunciations ---------- */
    function defaultPronunciations() {
      return {
        LA: [],
        IE: [],
        Ventura: [],
        SD: [],
      };
    }

    function loadPronunciations() {
      try {
        const raw = localStorage.getItem(PRON_KEY);
        if (!raw) return defaultPronunciations();
        const parsed = JSON.parse(raw);
        const base = defaultPronunciations();
        if (!parsed || typeof parsed !== "object") return base;

        for (const k of Object.keys(base)) {
          const arr = Array.isArray(parsed[k]) ? parsed[k] : [];
          base[k] = arr
            .filter(x => x && typeof x.term === "string" && typeof x.say === "string")
            .map(x => ({ term: x.term.trim(), say: x.say.trim() }))
            .filter(x => x.term && x.say);
        }
        return base;
      } catch {
        return defaultPronunciations();
      }
    }

    function savePronunciations() {
      try { localStorage.setItem(PRON_KEY, JSON.stringify(pronunciations)); } catch {}
    }

    /* ---------- Storage: WPM ---------- */
    function loadWpm() {
      try {
        const raw = localStorage.getItem(WPM_KEY);
        const n = Number(raw);
        if (!Number.isFinite(n) || n <= 30) return 180;
        return Math.round(n);
      } catch {
        return 180;
      }
    }
    function saveWpm(n) {
      localStorage.setItem(WPM_KEY, String(n));
    }

    /* ---------- URL builders ---------- */
    const TRAVELMODE = "driving";
    const DIRFLG = "d";
    function buildEmbedUrl(origin, destination) {
      const o = encodeURIComponent(origin.trim());
      const d = encodeURIComponent(destination.trim());
      return `https://www.google.com/maps?saddr=${o}&daddr=${d}&dirflg=${DIRFLG}&output=embed`;
    }
    function buildExternalDirUrl(origin, destination) {
      const o = encodeURIComponent(origin.trim());
      const d = encodeURIComponent(destination.trim());
      return `https://www.google.com/maps/dir/?api=1&origin=${o}&destination=${d}&travelmode=${TRAVELMODE}`;
    }

    /* ---------- Collapsible ---------- */
    function setCollapse(el, headerEl, chevEl, open, storageKey) {
      el.classList.toggle("open", open);
      headerEl.setAttribute("aria-expanded", String(open));
      chevEl.textContent = open ? "Hide" : "Show";
      if (storageKey) {
        try { localStorage.setItem(storageKey, open ? "1" : "0"); } catch (e) {}
      }
    }

    setCollapse(addCollapse, collapseHeader, collapseChev, false);
    function toggleAddCollapse() {
      setCollapse(addCollapse, collapseHeader, collapseChev, !addCollapse.classList.contains("open"));
    }
    collapseHeader.addEventListener("click", toggleAddCollapse);
    collapseHeader.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggleAddCollapse(); }
    });

    const scriptCollapseOpen = (localStorage.getItem("scriptCollapseOpen") === "1");
    setCollapse(scriptCollapse, scriptHeader, scriptChev, scriptCollapseOpen, "scriptCollapseOpen");
    function toggleScriptCollapse() {
      setCollapse(scriptCollapse, scriptHeader, scriptChev, !scriptCollapse.classList.contains("open"), "scriptCollapseOpen");
    }
    scriptHeader.addEventListener("click", toggleScriptCollapse);
    scriptHeader.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggleScriptCollapse(); }
    });
    const scriptCollapse2Open = (localStorage.getItem("scriptCollapse2Open") === "1");
    setCollapse(scriptCollapse2, scriptHeader2, scriptChev2, scriptCollapse2Open, "scriptCollapse2Open");
    function toggleScriptCollapse2() {
      setCollapse(scriptCollapse2, scriptHeader2, scriptChev2, !scriptCollapse2.classList.contains("open"), "scriptCollapse2Open");
    }
    scriptHeader2.addEventListener("click", toggleScriptCollapse2);
    scriptHeader2.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggleScriptCollapse2(); }
    });


    /* ---------- Script behavior ---------- */
    scriptText.value = loadText(SCRIPT_KEY, "");
    lockoutText.value = loadText(LOCKOUT_KEY, "");

    scriptText2.value = loadText(SCRIPT2_KEY, "");
    lockoutText2.value = loadText(LOCKOUT2_KEY, "");

    scriptText.addEventListener("input", () => {
      saveText(SCRIPT_KEY, scriptText.value);
      updateReadingLines();
    });
    lockoutText.addEventListener("input", () => {
      saveText(LOCKOUT_KEY, lockoutText.value);
      updateReadingLines();
    });

    scriptText2.addEventListener("input", () => {
      saveText(SCRIPT2_KEY, scriptText2.value);
      updateReadingLines();
    });
    lockoutText2.addEventListener("input", () => {
      saveText(LOCKOUT2_KEY, lockoutText2.value);
      updateReadingLines();
    });

    function countWords(str) {
      const t = (str || "").trim();
      if (!t) return 0;
      return t.split(/\s+/).filter(Boolean).length;
    }
    function formatMmSs(totalSeconds) {
      const s = Math.max(0, Math.round(totalSeconds));
      const m = Math.floor(s / 60);
      const r = s % 60;
      return `${m}:${String(r).padStart(2, "0")}`;
    }
    function estimateSeconds(words) {
      return wpm > 0 ? (words / wpm) * 60 : 0;
    }

    function updateReadingLines() {
      const scriptWords = countWords(scriptText.value);
      const lockWords = countWords(lockoutText.value);
      scriptReadingLine.textContent = `WPM: ${wpm} | Words: ${scriptWords} | Time: ${formatMmSs(estimateSeconds(scriptWords))}`;
      lockoutReadingLine.textContent = `Lockout words: ${lockWords} | Time: ${formatMmSs(estimateSeconds(lockWords))}`;

      const script2Words = countWords(scriptText2.value);
      const lock2Words = countWords(lockoutText2.value);
      scriptReadingLine2.textContent = `WPM: ${wpm} | Words: ${script2Words} | Time: ${formatMmSs(estimateSeconds(script2Words))}`;
      lockoutReadingLine2.textContent = `Lockout words: ${lock2Words} | Time: ${formatMmSs(estimateSeconds(lock2Words))}`;
    }
    updateReadingLines();
/* ---------- Modals ---------- */
    function openModal(el) { el.classList.add("open"); }
    function closeModal(el) { el.classList.remove("open"); }
    function backdropCloseHandler(modalEl) {
      modalEl.addEventListener("click", (e) => {
        if (e.target === modalEl) closeModal(modalEl);
      });
    }
    backdropCloseHandler(wpmModal);
    backdropCloseHandler(regionsModal);

    setWpmBtn.addEventListener("click", () => {
      wpmInput.value = String(wpm);
      openModal(wpmModal);
      setTimeout(() => wpmInput.focus(), 0);
    });

    setWpmBtn2.addEventListener("click", () => {
      wpmInput.value = String(wpm);
      openModal(wpmModal);
      setTimeout(() => wpmInput.focus(), 0);
    });
    wpmCancelBtn.addEventListener("click", () => closeModal(wpmModal));
    wpmSaveBtn.addEventListener("click", () => {
      const n = Number(String(wpmInput.value).trim());
      if (!Number.isFinite(n) || n < 30 || n > 800) {
        alert("Enter a valid WPM between 30 and 800.");
        return;
      }
      wpm = Math.round(n);
      saveWpm(wpm);
      updateReadingLines();

      closeModal(wpmModal);
    });

    /* ---------- Phones ---------- */
    const PHONE_SVG = `
<svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" class="phoneIconSvg">
  <path fill="#3ccf6e" d="M6.62 10.79c1.44 2.87 3.72 5.15 6.59 6.59l2.2-2.2
  c.27-.27.67-.36 1.02-.26 1.12.37 2.33.57 3.57.57
  .55 0 1 .45 1 1V20c0 .55-.45 1-1 1C10.07 21 3 13.93 3 5
  c0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1
  0 1.25.2 2.45.57 3.57.11.35.02.74-.25 1.01l-2.2 2.21z"/>
</svg>
`;

    const PHONE_ROWS = [
      { name: "CHP - Barstow", tag: "primary", phone: "7602558750" },
      { name: "CHP - San Luis Obispo", tag: "primary", phone: "8055493619" },
      { name: "CHP - Ventura", tag: "primary", phone: "8054774174" },
      { name: "CHP Indio", tag: "primary", phone: "7607728900" },
      { name: "CHP/TMC - Los Angeles", tag: "primary", phone: "3232593410" },
      { name: "CHP/TMC - Los Angeles", tag: "secondary", phone: "2138974388" },
      { name: "CHP/TMC - Los Angeles", tag: "other", phone: "3232592010" },
      { name: "CHP/TMC - Border Communications Center", tag: "primary", phone: "8586373800" },
      { name: "CHP/TMC - Inland", tag: "primary", phone: "9093832588" },
      { name: "CHP/TMC - Inland Dispatch", tag: "primary", phone: "9094285400" },
      { name: "CHP/TMC - Orange County", tag: "primary", phone: "9496514555" },
      { name: "CHP/TMC - Orange County", tag: "secondary", phone: "9496514554" },
      { name: "CHP/TMC - Orange County Dispatch", tag: "primary", phone: "9497846700" },
    ];

    function digitsOnly(s) {
      return String(s || "").replace(/\D/g, "");
    }
    function formatPhone(usDigits) {
      const d = digitsOnly(usDigits);
      if (d.length === 11 && d.startsWith("1")) return formatPhone(d.slice(1));
      if (d.length !== 10) return usDigits;
      const a = d.slice(0,3);
      const b = d.slice(3,6);
      const c = d.slice(6);
      return `(${a}) ${b}-${c}`;
    }

    function renderPhonesTable() {
      if (!phonesTbody) return;
      phonesTbody.innerHTML = "";

      for (const row of PHONE_ROWS) {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = `${row.name} (${row.tag})`;

        const tdPhone = document.createElement("td");
        const pretty = formatPhone(row.phone);
        tdPhone.textContent = pretty;

        const tdCall = document.createElement("td");
        tdCall.style.textAlign = "center";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "callBtn";
        btn.title = `Call ${pretty}`;
        btn.setAttribute("aria-label", `Call ${pretty}`);
        btn.innerHTML = PHONE_SVG;
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const d = digitsOnly(row.phone);
          if (!d) return;
          window.location.href = `tel:+1${d}`;
        });

        tdCall.appendChild(btn);

        tr.appendChild(tdName);
        tr.appendChild(tdPhone);
        tr.appendChild(tdCall);
        phonesTbody.appendChild(tr);
      }
    }

    function openPhones() {
      renderPhonesTable();
      openModal(phonesModal);
      if (phonesBtn) phonesBtn.classList.add("active-toggle");
    }
    function closePhones() {
      closeModal(phonesModal);
      if (phonesBtn) phonesBtn.classList.remove("active-toggle");
    }

    if (phonesBtn) {
      phonesBtn.addEventListener("click", () => {
        if (phonesModal.classList.contains("open")) closePhones();
        else openPhones();
      });
    }
    if (phonesCloseX) {
      phonesCloseX.addEventListener("click", closePhones);
    }

    /* ---------- Regions ---------- */
    const regionSelect = document.getElementById("region");

    function normalizeRegionId(id) {
      return String(id || "").trim();
    }

    function ensureRoutesUseValidRegions() {
      const valid = new Set(regions.map(r => r.id));
      const before = routes.length;
      routes = routes.filter(rt => valid.has(normalizeRegionId(rt.region || "")));
      if (routes.length !== before) saveRoutes();
    }

    function renderRegionSelect() {
      regionSelect.innerHTML = "";
      for (const r of regions) {
        const opt = document.createElement("option");
        opt.value = r.id;
        opt.textContent = r.label;
        regionSelect.appendChild(opt);
      }
      if (!regions.find(x => x.id === regionSelect.value)) {
        regionSelect.value = regions[0]?.id || "LA";
      }
    }

    function renderFilters() {
      filterBar.innerHTML = "";

      const allBtn = document.createElement("button");
      allBtn.type = "button";
      allBtn.dataset.filter = "ALL";
      allBtn.textContent = "All";
      allBtn.classList.toggle("active", activeFilter === "ALL");
      filterBar.appendChild(allBtn);

      for (const r of regions) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.dataset.filter = r.id;
        btn.textContent = r.label;
        btn.classList.toggle("active", activeFilter === r.id);
        filterBar.appendChild(btn);
      }
    }

    function setActiveFilter(filter) {
      activeFilter = filter;
      renderFilters();
      renderList();
    }

    filterBar.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-filter]");
      if (!btn) return;
      setActiveFilter(btn.dataset.filter);
    });

    function openRegionsManager() {
      renderRegionsManagerList();
      openModal(regionsModal);
    }

    function renderRegionsManagerList() {
      regionsList.innerHTML = "";
      regions.forEach((r) => {
        const row = document.createElement("div");
        row.className = "region-row";
        row.style.marginBottom = "8px";


        const left = document.createElement("div");
        left.style.flex = "1";

        const handle = document.createElement("div");
        handle.className = "dragHandle";
        handle.title = "Drag to reorder";
        handle.draggable = true;
        handle.addEventListener("pointerdown", (e) => e.stopPropagation());

        const pill = document.createElement("span");
        pill.className = "pill";
        pill.textContent = r.id;

        const name = document.createElement("span");
        name.style.marginLeft = "8px";
        name.textContent = r.label;

        left.appendChild(pill);
        left.appendChild(name);

        const del = document.createElement("button");
        del.type = "button";
        del.className = "danger";
        del.textContent = "Delete";
        del.disabled = regions.length <= 1;
        del.addEventListener("click", (e) => {
          e.stopPropagation();
          if (regions.length <= 1) return;

          const ok = confirm(
            `Delete region "${r.label}" (${r.id})?\n\nThis will also delete all routes in this region.`
          );
          if (!ok) return;

          const removedId = r.id;
          const removedRouteIds = new Set(routes.filter(rt => (rt.region || "") === removedId).map(rt => rt.id));

          routes = routes.filter(rt => (rt.region || "") !== removedId);
          saveRoutes();

          if (currentRoute && removedRouteIds.has(currentRoute.id)) {
            clearCurrent();
          }

          regions = regions.filter(x => x.id !== removedId);
          saveRegions();

          if (activeFilter === removedId) activeFilter = "ALL";

          renderRegionSelect();
          renderFilters();
          renderList();
          renderRegionsManagerList();
        });

        row.appendChild(left);
        row.appendChild(del);
        regionsList.appendChild(row);
      });
    }

    manageRegionsBtn.addEventListener("click", openRegionsManager);
    regionsCloseBtn.addEventListener("click", () => closeModal(regionsModal));

    regionsAddBtn.addEventListener("click", () => {
      const id = normalizeRegionId(newRegionId.value).replace(/\s+/g, "");
      const label = String(newRegionLabel.value || "").trim();

      if (!id || !label) {
        alert("Enter both a code and a name.");
        return;
      }
      if (!/^[A-Za-z0-9_:-]+$/.test(id)) {
        alert("Region code can only use letters/numbers and _:-");
        return;
      }
      if (regions.some(r => r.id.toLowerCase() === id.toLowerCase())) {
        alert("That region code already exists.");
        return;
      }

      regions.push({ id, label });
      saveRegions();

      newRegionId.value = "";
      newRegionLabel.value = "";

      renderRegionSelect();
      renderFilters();
      renderList();
      renderRegionsManagerList();
    });

    /* ---------- Filtering ---------- */

    /* ---------- Pronunciations ---------- */
    function normRegionKey(regionId) {
      if (regionId === "LA") return "LA";
      if (regionId === "IE") return "IE";
      if (regionId === "Ventura") return "Ventura";
      if (regionId === "SD") return "SD";
      return "LA";
    }

    function getPronRegions() {
      return [
        { id: "LA", label: "Los Angeles" },
        { id: "IE", label: "Inland Empire" },
        { id: "Ventura", label: "Ventura" },
        { id: "SD", label: "San Diego" },
      ];
    }

    function renderPronFilters() {
      if (!pronFilterBar) return;
      pronFilterBar.innerHTML = "";
      for (const r of getPronRegions()) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.dataset.pronfilter = r.id;
        btn.textContent = r.label;
        btn.classList.toggle("active", activePronRegion === r.id);
        pronFilterBar.appendChild(btn);
      }
    }

    function setActivePronRegion(regionId) {
      activePronRegion = normRegionKey(regionId);
      renderPronFilters();
      renderPronList();
    }

    if (pronFilterBar) {
      pronFilterBar.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-pronfilter]");
        if (!btn) return;
        setActivePronRegion(btn.dataset.pronfilter);
      });
    }

    function sortedPronList(regionKey) {
      const list = Array.isArray(pronunciations?.[regionKey]) ? pronunciations[regionKey] : [];
      const coll = new Intl.Collator(undefined, { sensitivity: "base", numeric: true });
      return list.slice().sort((a,b) => coll.compare(a.term || "", b.term || ""));
    }

    function renderPronList() {
      if (!pronListEl || !pronCountLabel) return;
      const key = normRegionKey(activePronRegion);
      const list = sortedPronList(key);

      pronCountLabel.textContent = `${list.length} items`;

      pronListEl.innerHTML = "";
      for (const item of list) {
        const row = document.createElement("div");
        row.className = "pronItem";

        const txt = document.createElement("div");
        txt.className = "txt";

        const term = document.createElement("div");
        term.className = "term";
        term.textContent = item.term;

        const say = document.createElement("div");
        say.className = "say";
        say.textContent = item.say;

        txt.appendChild(term);
        txt.appendChild(say);

        const actions = document.createElement("div");
        actions.className = "actions";

        const del = document.createElement("button");
        del.type = "button";
        del.className = "danger-x";
        del.title = "Delete";
        del.textContent = "✕";
        del.addEventListener("click", () => {
          const ok = confirm(`Delete pronunciation?\n\n${item.term} → ${item.say}`);
          if (!ok) return;
          const keep = (pronunciations[key] || []).filter(x => !(x.term === item.term && x.say === item.say));
          pronunciations[key] = keep;
          savePronunciations();
          renderPronList();
        });

        actions.appendChild(del);

        row.appendChild(txt);
        row.appendChild(actions);
        pronListEl.appendChild(row);
      }
    }

    function addPronunciation() {
      const key = normRegionKey(activePronRegion);
      const term = String(pronTerm?.value || "").trim();
      const say = String(pronSay?.value || "").trim();
      if (!term || !say) return;

      if (!pronunciations[key]) pronunciations[key] = [];
      pronunciations[key].push({ term, say });
      savePronunciations();

      if (pronTerm) pronTerm.value = "";
      if (pronSay) pronSay.value = "";
      renderPronList();
      if (pronTerm) pronTerm.focus();
    }

    if (pronAddBtn) pronAddBtn.addEventListener("click", addPronunciation);
    if (pronSay) {
      pronSay.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          addPronunciation();
        }
      });
    }

    const pronExportBtn = document.getElementById("pronExportBtn");
    const pronImportBtn = document.getElementById("pronImportBtn");
    const pronImportFile = document.getElementById("pronImportFile");

    if (pronExportBtn) {
      pronExportBtn.addEventListener("click", () => {
        const payload = {
          version: 1,
          updatedAt: new Date().toISOString(),
          pronunciations,
        };
        const text = JSON.stringify(payload, null, 2);
        const ts = new Date().toISOString().slice(0,19).replaceAll(":","-");
        downloadText(`pronunciations-${ts}.json`, text);
      });
    }

    if (pronImportBtn && pronImportFile) {
      pronImportBtn.addEventListener("click", () => pronImportFile.click());
      pronImportFile.addEventListener("change", async () => {
        const f = pronImportFile.files?.[0];
        pronImportFile.value = "";
        if (!f) return;
        try {
          const text = await f.text();
          const parsed = JSON.parse(text);
          const incoming = parsed?.pronunciations || parsed;
          if (!incoming || typeof incoming !== "object") throw new Error("Bad JSON.");

          const base = defaultPronunciations();
          for (const k of Object.keys(base)) {
            const arr = Array.isArray(incoming[k]) ? incoming[k] : [];
            base[k] = arr
              .filter(x => x && typeof x.term === "string" && typeof x.say === "string")
              .map(x => ({ term: x.term.trim(), say: x.say.trim() }))
              .filter(x => x.term && x.say);
          }

          pronunciations = base;
          savePronunciations();
          renderPronList();
          alert("Imported pronunciations.");
        } catch (err) {
          alert(`Import failed: ${err?.message || err}`);
        }
      });
    }

    function getFilteredRoutes() {
      if (activeFilter === "ALL") return routes;
      return routes.filter(r => (r.region || "") === activeFilter);
    }

    /* ---------- Drag / Drop ---------- */
    let draggedId = null;
    function indexById(id) { return routes.findIndex(r => r.id === id); }

    function moveRouteBefore(dragId, targetId) {
      if (!dragId || !targetId || dragId === targetId) return;
      const from = indexById(dragId);
      const to = indexById(targetId);
      if (from < 0 || to < 0) return;

      const item = routes[from];
      routes.splice(from, 1);
      const newIndex = from < to ? to - 1 : to;
      routes.splice(newIndex, 0, item);

      saveRoutes();
      renderList();
    }

    /* ---------- Maps + CAD toggle ---------- */
    function showGmaps() {
      cadVisible = false;
      quickmapVisible = false;
      camsVisible = false;
      pronVisible = false;
      cadBtn.classList.remove("active-toggle");
      quickmapBtn.classList.remove("active-toggle");
      camsBtn.classList.remove("active-toggle");
      if (pronBtn) pronBtn.classList.remove("active-toggle");
      if (pronPage) pronPage.style.display = "none";
      gmapsFrame.style.display = "block";
      cadFrame.style.display = "none";
      quickmapFrame.style.display = "none";
      camsFrame.style.display = "none";

      const hasRoute = !!currentRoute;
      openExternalBtn.disabled = !hasRoute;
      reverseCurrentBtn.disabled = !hasRoute;
    }

    function showCad() {
      cadVisible = true;
      quickmapVisible = false;
      camsVisible = false;
      pronVisible = false;
      cadBtn.classList.add("active-toggle");
      quickmapBtn.classList.remove("active-toggle");
      camsBtn.classList.remove("active-toggle");
      if (pronBtn) pronBtn.classList.remove("active-toggle");
      if (pronPage) pronPage.style.display = "none";
      gmapsFrame.style.display = "none";
      cadFrame.style.display = "block";
      quickmapFrame.style.display = "none";
      camsFrame.style.display = "none";

      if (!cadInitialized) {
        cadFrame.src = CAD_BASE;
        cadInitialized = true;
      }

      openExternalBtn.disabled = true;
      reverseCurrentBtn.disabled = true;
    }

    function showQuickmap() {
      cadVisible = false;
      quickmapVisible = true;
      camsVisible = false;
      pronVisible = false;
      cadBtn.classList.remove("active-toggle");
      quickmapBtn.classList.add("active-toggle");
      camsBtn.classList.remove("active-toggle");
      if (pronBtn) pronBtn.classList.remove("active-toggle");
      if (pronPage) pronPage.style.display = "none";
      gmapsFrame.style.display = "none";
      cadFrame.style.display = "none";
      quickmapFrame.style.display = "block";
      camsFrame.style.display = "none";

      if (!quickmapInitialized) {
        quickmapFrame.src = QUICKMAP_URL;
        quickmapInitialized = true;
      }

      openExternalBtn.disabled = true;
      reverseCurrentBtn.disabled = true;
    }

    cadBtn.addEventListener("click", () => {
      if (cadVisible) showGmaps();
      else showCad();
    });

    quickmapBtn.addEventListener("click", () => {
      if (quickmapVisible) showGmaps();
      else showQuickmap();
    });


    if (middleToggleBtn) {
      middleToggleBtn.addEventListener("click", () => {
        setMiddleCollapsed(!middleCollapsed);
      });
    }


    function showCams() {
      cadVisible = false;
      quickmapVisible = false;
      camsVisible = true;
      pronVisible = false;

      cadBtn.classList.remove("active-toggle");
      quickmapBtn.classList.remove("active-toggle");
      camsBtn.classList.add("active-toggle");
      if (pronBtn) pronBtn.classList.remove("active-toggle");
      if (pronPage) pronPage.style.display = "none";

      gmapsFrame.style.display = "none";
      cadFrame.style.display = "none";
      quickmapFrame.style.display = "none";
      camsFrame.style.display = "block";

      if (!camsInitialized) {
        camsFrame.src = CAMS_URL;
        camsInitialized = true;
      }

      openExternalBtn.disabled = true;
      reverseCurrentBtn.disabled = true;
    }

    camsBtn.addEventListener("click", () => {
      if (camsVisible) showGmaps();
      else showCams();
    });


    function showPron() {
      cadVisible = false;
      quickmapVisible = false;
      camsVisible = false;
      pronVisible = true;

      cadBtn.classList.remove("active-toggle");
      quickmapBtn.classList.remove("active-toggle");
      camsBtn.classList.remove("active-toggle");
      if (pronBtn) pronBtn.classList.add("active-toggle");

      gmapsFrame.style.display = "none";
      cadFrame.style.display = "none";
      quickmapFrame.style.display = "none";
      camsFrame.style.display = "none";
      if (pronPage) pronPage.style.display = "block";

      openExternalBtn.disabled = true;
      reverseCurrentBtn.disabled = true;

      renderPronFilters();
      renderPronList();
      if (pronTerm) pronTerm.focus();
    }

    if (pronBtn) {
      pronBtn.addEventListener("click", () => {
        if (pronVisible) showGmaps();
        else showPron();
      });
    }

    /* ---------- Current route selection ---------- */
    function setCurrent(route, reversed = false) {
      if (!route) return;

      currentRoute = route;
      currentReversed = reversed;

      const o = reversed ? route.destination : route.origin;
      const d = reversed ? route.origin : route.destination;

      gmapsFrame.src = buildEmbedUrl(o, d);

      const regionLabel = regions.find(r => r.id === (route.region || ""))?.label || route.region || "";
      currentLabel.textContent = `${route.name}${regionLabel ? " | " + regionLabel : ""}${reversed ? " (reversed)" : ""}`;

      if (!cadVisible) {
        openExternalBtn.disabled = false;
        reverseCurrentBtn.disabled = false;
      }
    }

    function clearCurrent() {
      currentRoute = null;
      currentReversed = false;
      currentLabel.textContent = "";
      if (!cadVisible) {
        openExternalBtn.disabled = true;
        reverseCurrentBtn.disabled = true;
      }
      gmapsFrame.src = "about:blank";
    }

    openExternalBtn.addEventListener("click", () => {
      if (!currentRoute) return;
      const o = currentReversed ? currentRoute.destination : currentRoute.origin;
      const d = currentReversed ? currentRoute.origin : currentRoute.destination;
      window.open(buildExternalDirUrl(o, d), "_blank", "noopener,noreferrer");
    });

    reverseCurrentBtn.addEventListener("click", () => {
      if (!currentRoute) return;
      setCurrent(currentRoute, !currentReversed);
    });

    /* ---------- Render list ---------- */
    function renderList() {
      const list = getFilteredRoutes();
      countLabel.textContent = `${list.length} shown / ${routes.length} total`;

      routeListEl.innerHTML = "";

      for (const r of list) {
        const card = document.createElement("div");
        card.className = "card";
        card.draggable = false;
        card.classList.add("clickable");

        const top = document.createElement("div");
        top.className = "top";

        const left = document.createElement("div");
        left.style.flex = "1";


const handle = document.createElement("div");
handle.className = "dragHandle";
handle.title = "Drag to reorder";
handle.draggable = true;
handle.addEventListener("pointerdown", (e) => e.stopPropagation());
handle.addEventListener("click", (e) => e.stopPropagation());

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = r.name;

        const regionLabel = regions.find(x => x.id === (r.region || ""))?.label || r.region || "";
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = `${regionLabel ? regionLabel + " | " : ""}${r.origin} → ${r.destination}`;

        left.appendChild(name);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.className = "card-actions";

        const go = document.createElement("button");
        go.type = "button";
        go.textContent = "⇢";
        go.addEventListener("click", (e) => {
          e.stopPropagation();
          showGmaps();
          setCurrent(r, false);
        });

        const rev = document.createElement("button");
        rev.type = "button";
        rev.textContent = "↩";
        rev.addEventListener("click", (e) => {
          e.stopPropagation();
          showGmaps();
          setCurrent(r, true);
        });

        const del = document.createElement("button");
        del.type = "button";
        del.className = "danger-x";
        del.title = "Delete route";
        del.textContent = "✕";
        del.addEventListener("click", (e) => {
          e.stopPropagation();
          const ok = confirm(`Delete route?\n\n${r.name}`);
          if (!ok) return;

          routes = routes.filter(x => x.id !== r.id);
          saveRoutes();

          if (currentRoute && currentRoute.id === r.id) clearCurrent();
          renderList();
        });

        right.appendChild(go);
        right.appendChild(rev);
        right.appendChild(del);

        top.appendChild(handle);
        top.appendChild(left);
        top.appendChild(right);

        card.appendChild(top);


        // Click anywhere on the card to show the route (buttons + handle still work)
        card.addEventListener("click", (e) => {
          if (e.target.closest("button")) return;
          if (e.target.closest(".dragHandle")) return;
          showGmaps();
          setCurrent(r, false);
        });

        // Drag events
        handle.addEventListener("dragstart", (e) => {
          draggedId = r.id;
          card.classList.add("dragging");
          e.dataTransfer.effectAllowed = "move";
        });
        handle.addEventListener("dragend", () => {
          draggedId = null;
          card.classList.remove("dragging");
          for (const el of routeListEl.querySelectorAll(".drop-hint")) el.classList.remove("drop-hint");
        });
        card.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.currentTarget.classList.add("drop-hint");
          e.dataTransfer.dropEffect = "move";
        });
        card.addEventListener("dragleave", (e) => {
          e.currentTarget.classList.remove("drop-hint");
        });
        card.addEventListener("drop", (e) => {
          e.preventDefault();
          e.currentTarget.classList.remove("drop-hint");
          moveRouteBefore(draggedId, r.id);
        });

        routeListEl.appendChild(card);
      }
    }

    /* ---------- Add route ---------- */
    routeForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const fd = new FormData(routeForm);
      const name = String(fd.get("name") || "").trim();
      const region = String(fd.get("region") || "").trim();
      const origin = String(fd.get("origin") || "").trim();
      const destination = String(fd.get("destination") || "").trim();

      if (!name || !origin || !destination) return;

      const valid = new Set(regions.map(r => r.id));
      if (!valid.has(region)) {
        alert("Select a valid region.");
        return;
      }

      routes.unshift({
        id: crypto.randomUUID(),
        region,
        name,
        origin,
        destination,
      });
 
      saveRoutes();
      routeForm.reset();
      renderRegionSelect();
      renderList();
    });

    /* ---------- Export / Import / Defaults ---------- */
    function escXml(s) {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll("\"","&quot;")
        .replaceAll("'","&apos;");
    }

    function datasetToXml(regs, rts) {
      let xml = `<?xml version="1.0" encoding="UTF-8"?>\n<data>\n`;

      xml += `  <regions>\n`;
      for (const r of regs) {
        xml += `    <region>\n`;
        xml += `      <id>${escXml(r.id || "")}</id>\n`;
        xml += `      <label>${escXml(r.label || "")}</label>\n`;
        xml += `    </region>\n`;
      }
      xml += `  </regions>\n`;

      xml += `  <routes>\n`;
      for (const r of rts) {
        xml += `    <route>\n`;
        xml += `      <id>${escXml(r.id || "")}</id>\n`;
        xml += `      <region>${escXml(r.region || "")}</region>\n`;
        xml += `      <name>${escXml(r.name || "")}</name>\n`;
        xml += `      <origin>${escXml(r.origin || "")}</origin>\n`;
        xml += `      <destination>${escXml(r.destination || "")}</destination>\n`;
        xml += `    </route>\n`;
      }
      xml += `  </routes>\n`;

      xml += `</data>\n`;
      return xml;
    }

    function downloadText(filename, text) {
      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    exportRoutesBtn.addEventListener("click", () => {
      const xml = datasetToXml(regions, routes);
      const ts = new Date().toISOString().slice(0,19).replaceAll(":","-");
      downloadText(`routes-${ts}.xml`, xml);
    });

    importRoutesBtn.addEventListener("click", () => importFile.click());

    importFile.addEventListener("change", async () => {
      const f = importFile.files?.[0];
      importFile.value = "";
      if (!f) return;

      const text = await f.text();
      try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, "text/xml");

        // Support both:
        //  - new format: <data><regions>...<routes>...</routes></data>
        //  - old format: <routes><route>...</route></routes> (routes only)
        const regionNodes = Array.from(doc.querySelectorAll("regions > region"));
        const routeNodesNew = Array.from(doc.querySelectorAll("routes > route"));
        const routeNodesOld = Array.from(doc.querySelectorAll("routes > route")).length ? [] : Array.from(doc.querySelectorAll("routes > route")); // unused, kept harmless
        const routeNodesLegacy = Array.from(doc.querySelectorAll("routes > route"));
        const legacyRoutesOnlyNodes = Array.from(doc.querySelectorAll("routes > route"));
        const routesOnlyNodes = Array.from(doc.querySelectorAll("routes > route"));
        const reallyOldNodes = Array.from(doc.querySelectorAll("routes > route"));

        // Actually detect old format correctly
        const oldFormatRouteNodes = Array.from(doc.querySelectorAll("routes > route"));
        const oldTopLevelRoutes = Array.from(doc.querySelectorAll("routes > route"));
        // If they exported old earlier version here: <routes><route>...</route></routes>
        const routesOnly = Array.from(doc.querySelectorAll("routes > route")).length === 0
          ? Array.from(doc.querySelectorAll("routes > route"))
          : [];

        // Proper detection:
        const newRoutesNodes = Array.from(doc.querySelectorAll("data > routes > route, routes > route"));
        const isNewDataset = doc.querySelector("data > regions") != null || doc.querySelector("regions") != null;

        // Parse regions if present
        let importedRegions = null;
        if (isNewDataset && regionNodes.length) {
          importedRegions = regionNodes
            .map(n => ({
              id: (n.querySelector("id")?.textContent || "").trim(),
              label: (n.querySelector("label")?.textContent || "").trim(),
            }))
            .filter(r => r.id && r.label);
          if (!importedRegions.length) importedRegions = null;
        }

        // Fallback if regions missing: keep current regions
        const workingRegions = importedRegions ?? regions;

        const valid = new Set(workingRegions.map(r => r.id));

        // Parse routes: accept either <data><routes> OR legacy <routes> root
        const routeNodes = Array.from(doc.querySelectorAll("data > routes > route"));
        const legacyRootNodes = Array.from(doc.querySelectorAll("routes > route"));
        const finalRouteNodes = routeNodes.length ? routeNodes : legacyRootNodes;

        if (!finalRouteNodes.length) throw new Error("No <route> nodes found.");

        const importedRoutes = finalRouteNodes.map(n => ({
          id: (n.querySelector("id")?.textContent || crypto.randomUUID()).trim(),
          region: (n.querySelector("region")?.textContent || "").trim(),
          name: (n.querySelector("name")?.textContent || "").trim(),
          origin: (n.querySelector("origin")?.textContent || "").trim(),
          destination: (n.querySelector("destination")?.textContent || "").trim(),
        }))
        .filter(r => r.name && r.origin && r.destination && valid.has(r.region));

        if (!importedRoutes.length) {
          throw new Error("Imported file had no usable routes (or regions didn't match).");
        }

        // Commit import
        regions = workingRegions;
        routes = importedRoutes;

        saveRegions();
        saveRoutes();

        // UI refresh
        if (activeFilter !== "ALL" && !valid.has(activeFilter)) activeFilter = "ALL";
        clearCurrent();
        renderRegionSelect();
        renderFilters();
        renderList();

        alert(`Imported ${routes.length} routes${importedRegions ? " and regions" : ""}.`);
      } catch (err) {
        alert(`Import failed: ${err?.message || err}`);
      }
    });

    loadDefaultsBtn.addEventListener("click", () => {
      const ok = confirm("Replace your current routes AND regions with the built-in defaults?");
      if (!ok) return;

      regions = defaultRegions();
      routes = defaultRoutes();

      saveRegions();
      saveRoutes();

      activeFilter = "ALL";
      clearCurrent();
      renderRegionSelect();
      renderFilters();
      renderList();
    });

    resetBtn.addEventListener("click", () => {
      routeForm.reset();
      renderRegionSelect();
    });

// Try it: preview without saving
if (tryRouteBtn) {
  tryRouteBtn.addEventListener("click", (e) => {
    e.preventDefault();

    const fd = new FormData(routeForm);
    const name = String(fd.get("name") || "").trim() || "Unsaved route";
    const region = String(fd.get("region") || "").trim();
    const origin = String(fd.get("origin") || "").trim();
    const destination = String(fd.get("destination") || "").trim();

    if (!origin || !destination) return;

    // Optional: only enforce region if you want it required for Try
    const valid = new Set(regions.map(r => r.id));
    if (region && !valid.has(region)) {
      alert("Select a valid region.");
      return;
    }

    showGmaps();
    setCurrent({ id: "__tryit__", region, name, origin, destination }, false);
  });
}

    /* ---------- Pane resize (saved) ---------- */
    function loadPaneWidth(key) {
      try {
        const raw = localStorage.getItem(key);
        const n = Number(raw);
        if (!Number.isFinite(n)) return null;
        return Math.max(240, Math.min(n, window.innerWidth * 0.9));
      } catch {
        return null;
      }
    }
    function savePaneWidth(key, px) {
      try { localStorage.setItem(key, String(Math.max(0, Math.round(px)))); } catch {}
    }

    const savedLeftWidth = loadPaneWidth(LEFT_WIDTH_KEY);
    if (savedLeftWidth) leftPane.style.width = `${savedLeftWidth}px`;

    const savedMiddleWidth = loadPaneWidth(MIDDLE_WIDTH_KEY);
    if (savedMiddleWidth) middlePane.style.width = `${savedMiddleWidth}px`;

    // Middle pane collapse persistence
    setMiddleCollapsed(loadMiddleCollapsed());

    function clamp(n, min, max) {
      return Math.max(min, Math.min(n, max));
    }

    // Left splitter: sets left pane width
    let resizingLeft = false;
    splitter.addEventListener("pointerdown", (e) => {
      resizingLeft = true;
      splitter.setPointerCapture(e.pointerId);
    });
    splitter.addEventListener("pointermove", (e) => {
      if (!resizingLeft) return;
      const rect = document.body.getBoundingClientRect();
      const x = e.clientX - rect.left;

      const splitterW = splitter.getBoundingClientRect().width || 8;
      const splitter2W = middleCollapsed ? 0 : (splitter2.getBoundingClientRect().width || 8);
      const rightMin = 320;
      const middleMin = middleCollapsed ? 0 : 260;

      const maxLeft = window.innerWidth - splitterW - splitter2W - rightMin - middleMin;
      const px = clamp(x, 240, Math.max(240, maxLeft));

      leftPane.style.width = `${px}px`;
      savePaneWidth(LEFT_WIDTH_KEY, px);
    });
    splitter.addEventListener("pointerup", (e) => {
      resizingLeft = false;
      splitter.releasePointerCapture(e.pointerId);
    });

    // Middle splitter: sets middle pane width
    let resizingMiddle = false;
    splitter2.addEventListener("pointerdown", (e) => {
      if (middleCollapsed) return;
      resizingMiddle = true;
      splitter2.setPointerCapture(e.pointerId);
    });
    splitter2.addEventListener("pointermove", (e) => {
      if (!resizingMiddle) return;

      const rect = document.body.getBoundingClientRect();
      const x = e.clientX - rect.left;

      const leftW = leftPane.getBoundingClientRect().width;
      const splitterW = splitter.getBoundingClientRect().width || 8;
      const splitter2W = splitter2.getBoundingClientRect().width || 8;

      const rightMin = 320;
      const middleMin = 260;
      const maxMiddle = window.innerWidth - leftW - splitterW - splitter2W - rightMin;

      const px = clamp(x - leftW - splitterW, middleMin, Math.max(middleMin, maxMiddle));

      middlePane.style.width = `${px}px`;
      savePaneWidth(MIDDLE_WIDTH_KEY, px);
    });
    splitter2.addEventListener("pointerup", (e) => {
      resizingMiddle = false;
      splitter2.releasePointerCapture(e.pointerId);
    });


    /* ---------- Init ---------- */
    function init() {
      renderRegionSelect();
      renderFilters();
      ensureRoutesUseValidRegions();
      saveRoutes();
      renderList();

      renderPronFilters();
      renderPronList();
      if (pronPage) pronPage.style.display = "none";

      // start on gmaps
      gmapsFrame.src = "about:blank";
      showGmaps();
    }

    init();
  </script>

  <script>
  (function () {
    const btn = document.getElementById('fullscreenBtn');
    const target = document.querySelector('.app') || document.documentElement;

    function isFs() { return document.fullscreenElement != null; }

    async function toggle() {
      try {
        if (isFs()) {
          await document.exitFullscreen();
        } else {
          await target.requestFullscreen();
        }
      } catch (e) {
        console.warn('Fullscreen failed:', e);
      }
    }

    if (btn) {
      btn.addEventListener('click', toggle);
      document.addEventListener('fullscreenchange', () => {
        btn.textContent = isFs() ? '↙' : '↕';
      });
    }
  })();
  </script>

</body>
</html>
