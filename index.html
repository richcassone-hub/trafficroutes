<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Traffic Travel-Time Board</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .app { display: flex; height: 100vh; width: 100vw; overflow: hidden; }

    .left {
      width: 340px;
      min-width: 260px;
      max-width: 60vw;
      border-right: 1px solid rgba(128,128,128,0.35);
      padding: 12px;
      box-sizing: border-box;
      overflow: auto;
    }

    .splitter {
      width: 8px;
      cursor: col-resize;
      background: rgba(128,128,128,0.12);
      border-right: 1px solid rgba(128,128,128,0.25);
      border-left: 1px solid rgba(128,128,128,0.25);
      user-select: none;
      touch-action: none;
    }
    .splitter:hover { background: rgba(128,128,128,0.18); }

    .right { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    .toolbar {
      display: flex; gap: 8px; align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(128,128,128,0.35);
      flex-wrap: wrap;
    }
    .toolbar .title { font-weight: 700; }

    .frameWrap { position: relative; flex: 1; min-height: 0; }
    iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: 0; }

    /* Collapsible blocks */
    .collapse {
      border: 1px solid rgba(128,128,128,0.35);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .collapse-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 10px;
      cursor: pointer;
      user-select: none;
      background: rgba(128,128,128,0.10);
    }
    .collapse-header .label { font-weight: 700; }
    .collapse-header .chev {
      font-size: 12px;
      opacity: 0.8;
      padding: 4px 10px;
      border: 1px solid rgba(128,128,128,0.35);
      border-radius: 999px;
    }
    .collapse-body {
      padding: 10px;
      background: rgba(128,128,128,0.12);
      display: none;
    }
    .collapse.open .collapse-body { display: block; }

    label { display: block; font-size: 12px; opacity: 0.85; margin-top: 10px; }
    input, select, textarea, button { font: inherit; }
    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid rgba(128,128,128,0.4);
      border-radius: 10px;
      background: transparent;
      color: inherit;
      box-sizing: border-box;
    }
    textarea { resize: vertical; }

    /* Small, rounded buttons */
    button {
      cursor: pointer;
      padding: 6px 10px;
      border: 1px solid rgba(128,128,128,0.4);
      border-radius: 999px;
      background: transparent;
      color: inherit;
      line-height: 1;
    }
    .toolbar button { padding: 6px 10px; border-radius: 999px; }

    .row { display:flex; gap:8px; align-items: center; }
    .row > * { flex: 1; }
    .hint { font-size: 12px; opacity: 0.75; margin-top: 10px; line-height: 1.35; }
    .small { font-size: 12px; opacity: 0.85; }
    .kicker { display:flex; align-items: baseline; justify-content: space-between; gap:10px; margin-top: 10px; }
    .section-title { font-weight: 700; margin: 16px 0 6px; }

    .filters { display: flex; flex-wrap: wrap; gap: 6px; margin: 10px 0; }
    .filters button.active {
      border-color: rgba(128,128,128,0.85);
      font-weight: 700;
      opacity: 1;
    }

    .list { display: flex; flex-direction: column; gap: 8px; }
    .card {
      border: 1px solid rgba(128,128,128,0.35);
      border-radius: 12px;
      padding: 10px;
      background: rgba(0,0,0,0);
    }
    .card .top { display:flex; justify-content: space-between; gap:10px; align-items: start; }
    .card .name { font-weight: 700; }
    .card .meta { font-size: 12px; opacity: 0.8; margin-top: 4px; line-height: 1.3; }
    .card[draggable="true"] { cursor: grab; }
    .card.dragging { opacity: 0.55; }
    .drop-hint { outline: 2px dashed rgba(128,128,128,0.6); outline-offset: 2px; }

    /* Red X delete */
    .danger-x {
      padding: 6px 10px;
      border-radius: 999px;
      border-color: rgba(255,80,80,0.75);
      color: rgb(255,80,80);
      font-weight: 800;
    }

    .reading-time { margin-top: 8px; font-size: 12px; opacity: 0.85; }

    /* Script: reading line + Set WPM on same row */
    .script-meta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-top: 8px;
    }
    .script-meta .reading-time{
      margin-top: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Card actions: Show / Reverse / X on one line, tighter */
    .card-actions{
      display:flex;
      gap:4px;
      flex-wrap: nowrap;
      align-items:center;
      white-space: nowrap;
    }

    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }
    .modal-backdrop.open { display: flex; }
    .modal {
      width: min(680px, 96vw);
      max-height: 86vh;
      overflow: auto;
      border: 1px solid rgba(128,128,128,0.35);
      border-radius: 14px;
      background: rgba(24,24,24,0.92);
      color: inherit;
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
      padding: 14px;
      box-sizing: border-box;
    }
    .modal h3 { margin: 0 0 10px 0; }
    .modal .bar { display:flex; gap:8px; justify-content: flex-end; margin-top: 12px; flex-wrap: wrap; }
    .modal .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .modal .hr { height: 1px; background: rgba(128,128,128,0.30); margin: 12px 0; }

    .region-row { display:flex; gap:8px; align-items:center; }
    .region-row .pill { font-size: 12px; opacity: 0.9; padding: 4px 8px; border: 1px solid rgba(128,128,128,0.35); border-radius: 999px; }
    .region-row button.danger { border-color: rgba(255,80,80,0.75); color: rgb(255,80,80); }

    /* CAD active shaded */
    .toolbar button.active-toggle {
      border-color: rgba(128,128,128,0.85);
      font-weight: 700;
      background: rgba(128,128,128,0.22);
    }

    .add-actions {
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
  
    /* Stopwatch (left pane, pinned) */
    .stopwatchBar{
      position: sticky;
      top: 0;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid rgba(128,128,128,0.35);
      border-radius: 12px;
      background: rgba(128,128,128,0.10);
    }
    .stopwatchDisplay{
      font-weight: 800;
      font-size: clamp(48px, 9vw, 48px);
      line-height: 1;
      letter-spacing: 0.5px;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }
    .stopwatchBtns{
      display: flex;
      gap: 8px;
      flex: 0 0 auto;
      align-items: center;
      white-space: nowrap;
    }

  </style>
</head>
<body>
  <div class="app">
    <aside class="left" id="leftPane">

      <!-- Stopwatch (pinned) -->
      <div class="stopwatchBar" id="stopwatchBar" aria-label="Stopwatch">
        <div class="stopwatchDisplay" id="stopwatchDisplay">00:00</div>
        <div class="stopwatchBtns">
          <button type="button" id="stopwatchToggleBtn">Start</button>
          <button type="button" id="stopwatchResetBtn">Reset</button>
        </div>
      </div>

      <!-- Script pane -->
      <div class="collapse" id="scriptCollapse">
        <div class="collapse-header" id="scriptHeader" role="button" tabindex="0" aria-expanded="false">
          <div class="label">Script</div>
          <div class="chev" id="scriptChev">Show</div>
        </div>
        <div class="collapse-body">
          <label for="scriptText">Script</label>
          <textarea id="scriptText" rows="10" placeholder="Type script here..."></textarea>

          <div class="script-meta">
            <div class="reading-time" id="scriptReadingLine">WPM: 180 | Script words: 0 | Reading time: 0:00</div>
            <button type="button" id="setWpmBtn">Set WPM</button>
          </div>

          <label for="lockoutText">Lock-out</label>
          <textarea id="lockoutText" rows="2" placeholder="Lock-out..."></textarea>

          <div class="reading-time" id="lockoutReadingLine">Lockout words: 0 | Reading time: 0:00</div>
        </div>
      </div>

      <!-- Add Route pane -->
      <div class="collapse" id="addCollapse">
        <div class="collapse-header" id="collapseHeader" role="button" tabindex="0" aria-expanded="false">
          <div class="label">Add Route</div>
          <div class="chev" id="collapseChev">Show</div>
        </div>
        <div class="collapse-body">
          <form id="routeForm">
            <label for="name">Name</label>
            <input id="name" name="name" required placeholder="SB 101 – Sherman Oaks to Downtown" />

            <div class="row" style="gap:10px;">
              <div>
                <label for="region">Region</label>
                <select id="region" name="region"></select>
              </div>
              <div style="flex:0 0 auto; align-self: end;">
                <button type="button" id="manageRegionsBtn" title="Add or delete regions">Manage Regions</button>
              </div>
            </div>

            <label for="origin">Origin (place or lat,lng)</label>
            <input id="origin" name="origin" required placeholder="Sherman Oaks, CA" />

            <label for="destination">Destination (place or lat,lng)</label>
            <input id="destination" name="destination" required placeholder="Downtown Los Angeles, CA" />

            <div style="display:flex; gap:8px; margin-top: 12px;">
              <button type="submit" style="flex:1; border-radius: 12px;">Add</button>
              <button type="button" id="resetBtn" title="Reset form" style="border-radius: 12px;">Reset</button>
            </div>

            <div class="add-actions">
              <button type="button" id="exportRoutesBtn">Export Routes</button>
              <button type="button" id="importRoutesBtn">Import Routes</button>
              <button type="button" id="loadDefaultsBtn">Load Defaults</button>
              <input type="file" id="importFile" accept=".xml,text/xml,application/xml" style="display:none" />
            </div>

            <div class="hint">
              Defaults live in this file (no external files; no server required).
            </div>
          </form>
        </div>
      </div>

      <div class="kicker">
        <div class="section-title" style="margin: 0;">Routes</div>
        <div class="small" id="countLabel"></div>
      </div>

      <div class="filters" id="filterBar"></div>
      <div id="routeList" class="list"></div>
    </aside>

    <div class="splitter" id="splitter" title="Drag to resize"></div>

    <main class="right">
      <div class="toolbar">
        <div class="title">Map</div>
        <div id="currentLabel" class="small" style="margin-left:10px; opacity:0.8;"></div>
        <div style="flex:1;"></div>
        <button id="reverseCurrentBtn" disabled>Reverse</button>
        <button id="openExternalBtn" disabled>Open in new tab</button>
        <button id="cadBtn" type="button">CAD</button>
        <button id="quickmapBtn" type="button">QuickMap</button>
      </div>

      <div class="frameWrap">
        <iframe id="gmapsFrame" title="Google Maps" style="display:block;"></iframe>
        <iframe id="cadFrame" title="CAD" style="display:none;"></iframe>
        <iframe id="quickmapFrame" title="QuickMap" style="display:none;"></iframe>
      </div>
    </main>
  </div>

  <!-- Modal: WPM -->
  <div class="modal-backdrop" id="wpmModal">
    <div class="modal">
      <h3>Words per minute</h3>
      <div class="small">Used for reading-time estimates.</div>
      <div class="hr"></div>
      <label for="wpmInput">WPM</label>
      <input id="wpmInput" inputmode="numeric" placeholder="180" />
      <div class="bar">
        <button type="button" id="wpmCancelBtn">Cancel</button>
        <button type="button" id="wpmSaveBtn">Save</button>
      </div>
    </div>
  </div>

  <!-- Modal: Regions -->
  <div class="modal-backdrop" id="regionsModal">
    <div class="modal">
      <h3>Manage regions</h3>
      <div class="small">Add or delete regions. Deleting a region deletes all routes in that region.</div>
      <div class="hr"></div>

      <div id="regionsList"></div>

      <div class="hr"></div>

      <div class="grid">
        <div>
          <label for="newRegionId">Code (short)</label>
          <input id="newRegionId" placeholder="e.g., OC" />
          <div class="small">Use a short code like LA, Ventura, IE, SD, OC.</div>
        </div>
        <div>
          <label for="newRegionLabel">Name</label>
          <input id="newRegionLabel" placeholder="e.g., Orange County" />
        </div>
      </div>

      <div class="bar" style="justify-content: space-between;">
        <button type="button" id="regionsCloseBtn">Close</button>
        <div style="display:flex; gap:8px; flex-wrap: wrap;">
          <button type="button" id="regionsAddBtn">Add Region</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "traffic_board_routes_v11";
    const LEFT_WIDTH_KEY = "traffic_board_left_width_v1";

    const SCRIPT_KEY = "traffic_board_script_v1";
    const LOCKOUT_KEY = "traffic_board_lockout_v1";
    const WPM_KEY = "traffic_board_wpm_v1";

    const REGIONS_KEY = "traffic_board_regions_v1";

    const CAD_BASE = "/mycad.html";
    const QUICKMAP_URL = "https://quickmap.dot.ca.gov/mindex.html";

    const STOPWATCH_KEY = "traffic_board_stopwatch_v1"; // optional persistence (elapsed ms only)

    const stopwatchDisplay = document.getElementById("stopwatchDisplay");
    const stopwatchToggleBtn = document.getElementById("stopwatchToggleBtn");
    const stopwatchResetBtn = document.getElementById("stopwatchResetBtn");

    let swRunning = false;
    let swStart = 0;        // performance.now() when started
    let swElapsed = loadStopwatchElapsed(); // ms accumulated
    let swTimer = null;

    function loadStopwatchElapsed() {
      try {
        const raw = localStorage.getItem(STOPWATCH_KEY);
        const n = Number(raw);
        return Number.isFinite(n) && n >= 0 ? n : 0;
      } catch {
        return 0;
      }
    }
    function saveStopwatchElapsed(ms) {
      try { localStorage.setItem(STOPWATCH_KEY, String(Math.max(0, Math.round(ms)))); } catch {}
    }

    function pad2(n) { return String(n).padStart(2, "0"); }
    function formatStopwatch(ms) {
      const totalSec = Math.floor(Math.max(0, ms) / 1000);
      const mm = Math.floor(totalSec / 60);
      const ss = totalSec % 60;
      return `${pad2(mm)}:${pad2(ss)}`;
    }
    function renderStopwatch() {
      stopwatchDisplay.textContent = formatStopwatch(swElapsed + (swRunning ? (performance.now() - swStart) : 0));
    }

    function stopStopwatch() {
      if (!swRunning) return;
      swElapsed = swElapsed + (performance.now() - swStart);
      swRunning = false;
      swStart = 0;
      if (swTimer) { clearInterval(swTimer); swTimer = null; }
      stopwatchToggleBtn.textContent = "Start";
      saveStopwatchElapsed(swElapsed);
      renderStopwatch();
    }

    function startStopwatch() {
      if (swRunning) return;
      swRunning = true;
      swStart = performance.now();
      stopwatchToggleBtn.textContent = "Stop";
      if (swTimer) clearInterval(swTimer);
      swTimer = setInterval(() => {
        renderStopwatch();
      }, 200);
      renderStopwatch();
    }

    stopwatchToggleBtn.addEventListener("click", () => {
      if (swRunning) stopStopwatch();
      else startStopwatch();
    });

    stopwatchResetBtn.addEventListener("click", () => {
      swElapsed = 0;
      saveStopwatchElapsed(swElapsed);
      if (swRunning) {
        swStart = performance.now();
      } else {
        renderStopwatch();
      }
    });

    // Initial paint
    renderStopwatch();

    // ---------- DEFAULTS LIVE HERE (single-file) ----------
    function defaultRegions() {
      return [
        { id: "LA", label: "Los Angeles" },
        { id: "Ventura", label: "Ventura" },
        { id: "IE", label: "Inland Empire" },
        { id: "SD", label: "San Diego" },
      ];
    }

    function defaultRoutes() {
      return [
        // Los Angeles County (10)
        { id: crypto.randomUUID(), region: "LA", name: "SB 101 – Sherman Oaks to Downtown", origin: "Sherman Oaks, CA", destination: "Downtown Los Angeles, CA" },
        { id: crypto.randomUUID(), region: "LA", name: "SB 405 – Sherman Oaks to West LA", origin: "Sherman Oaks, CA", destination: "West Los Angeles, CA" },
        { id: crypto.randomUUID(), region: "LA", name: "EB 10 – West LA to Downtown", origin: "West Los Angeles, CA", destination: "Downtown Los Angeles, CA" },
        { id: crypto.randomUUID(), region: "LA", name: "EB 105 – Hawthorne to Norwalk", origin: "Hawthorne, CA", destination: "Norwalk, CA" },
        { id: crypto.randomUUID(), region: "LA", name: "NB 110 – Long Beach to Downtown", origin: "Long Beach, CA", destination: "Downtown Los Angeles, CA" },
        { id: crypto.randomUUID(), region: "LA", name: "NB 710 – Long Beach to East LA", origin: "Long Beach, CA", destination: "East Los Angeles, CA" },
        { id: crypto.randomUUID(), region: "LA", name: "NB 5 – Santa Fe Springs to Downtown", origin: "Santa Fe Springs, CA", destination: "Downtown Los Angeles, CA" },
        { id: crypto.randomUUID(), region: "LA", name: "SB 5 – Sylmar to Downtown", origin: "Sylmar, CA", destination: "Downtown Los Angeles, CA" },
        { id: crypto.randomUUID(), region: "LA", name: "NB 605 – Santa Fe Springs to Duarte", origin: "Santa Fe Springs, CA", destination: "Duarte, CA" },
        { id: crypto.randomUUID(), region: "LA", name: "WB 210 – San Dimas to Pasadena", origin: "San Dimas, CA", destination: "Pasadena, CA" },

        // Ventura County (6)
        { id: crypto.randomUUID(), region: "Ventura", name: "SB 101 – Oxnard to Thousand Oaks", origin: "Oxnard, CA", destination: "Thousand Oaks, CA" },
        { id: crypto.randomUUID(), region: "Ventura", name: "NB 101 – Oxnard to Santa Barbara", origin: "Oxnard, CA", destination: "Santa Barbara, CA" },
        { id: crypto.randomUUID(), region: "Ventura", name: "EB 118 – Saticoy to Moorpark", origin: "Saticoy, CA", destination: "Moorpark, CA" },
        { id: crypto.randomUUID(), region: "Ventura", name: "EB 118 – Moorpark to Simi Valley", origin: "Moorpark, CA", destination: "Simi Valley, CA" },
        { id: crypto.randomUUID(), region: "Ventura", name: "WB 126 – Fillmore to Ventura", origin: "Fillmore, CA", destination: "Ventura, CA" },
        { id: crypto.randomUUID(), region: "Ventura", name: "EB 150 – Santa Paula to Ojai", origin: "Santa Paula, CA", destination: "Ojai, CA" },

        // Inland Empire (8)
        { id: crypto.randomUUID(), region: "IE", name: "SB 15 – Cajon Pass to Fontana", origin: "Cajon Pass, CA", destination: "Fontana, CA" },
        { id: crypto.randomUUID(), region: "IE", name: "SB 15 – Fontana to Corona", origin: "Fontana, CA", destination: "Corona, CA" },
        { id: crypto.randomUUID(), region: "IE", name: "EB 210 – Rancho Cucamonga to San Bernardino", origin: "Rancho Cucamonga, CA", destination: "San Bernardino, CA" },
        { id: crypto.randomUUID(), region: "IE", name: "EB 10 – Ontario to San Bernardino", origin: "Ontario, CA", destination: "San Bernardino, CA" },
        { id: crypto.randomUUID(), region: "IE", name: "WB 91 – Riverside to Orange County", origin: "Riverside, CA", destination: "Orange County, CA" },
        { id: crypto.randomUUID(), region: "IE", name: "WB 60 – Riverside to Chino", origin: "Riverside, CA", destination: "Chino, CA" },
        { id: crypto.randomUUID(), region: "IE", name: "NB 215 – Riverside to San Bernardino", origin: "Riverside, CA", destination: "San Bernardino, CA" },
        { id: crypto.randomUUID(), region: "IE", name: "WB 10 – Redlands to the LA County line", origin: "Redlands, CA", destination: "Los Angeles County, CA" },

        // San Diego County (8)
        { id: crypto.randomUUID(), region: "SD", name: "SB 5 – Oceanside to Downtown San Diego", origin: "Oceanside, CA", destination: "Downtown San Diego, CA" },
        { id: crypto.randomUUID(), region: "SD", name: "SB 15 – Escondido to Mission Valley", origin: "Escondido, CA", destination: "Mission Valley, San Diego, CA" },
        { id: crypto.randomUUID(), region: "SD", name: "SB 805 – Carlsbad to Downtown San Diego", origin: "Carlsbad, CA", destination: "Downtown San Diego, CA" },
        { id: crypto.randomUUID(), region: "SD", name: "EB 8 – Ocean Beach area to La Mesa", origin: "Ocean Beach, San Diego, CA", destination: "La Mesa, CA" },
        { id: crypto.randomUUID(), region: "SD", name: "SB 125 – La Mesa to Chula Vista", origin: "La Mesa, CA", destination: "Chula Vista, CA" },
        { id: crypto.randomUUID(), region: "SD", name: "EB 94 – Downtown San Diego to Spring Valley", origin: "Downtown San Diego, CA", destination: "Spring Valley, CA" },
        { id: crypto.randomUUID(), region: "SD", name: "EB 78 – Oceanside to Escondido", origin: "Oceanside, CA", destination: "Escondido, CA" },
        { id: crypto.randomUUID(), region: "SD", name: "EB 76 – Fallbrook to Oceanside", origin: "Fallbrook, CA", destination: "Oceanside, CA" },
      ];
    }
    // -----------------------------------------------------

    const routeForm = document.getElementById("routeForm");
    const routeListEl = document.getElementById("routeList");
    const currentLabel = document.getElementById("currentLabel");
    const openExternalBtn = document.getElementById("openExternalBtn");
    const reverseCurrentBtn = document.getElementById("reverseCurrentBtn");
    const resetBtn = document.getElementById("resetBtn");
    const filterBar = document.getElementById("filterBar");
    const countLabel = document.getElementById("countLabel");

    const exportRoutesBtn = document.getElementById("exportRoutesBtn");
    const importRoutesBtn = document.getElementById("importRoutesBtn");
    const loadDefaultsBtn = document.getElementById("loadDefaultsBtn");
    const importFile = document.getElementById("importFile");

    const leftPane = document.getElementById("leftPane");
    const splitter = document.getElementById("splitter");

    const addCollapse = document.getElementById("addCollapse");
    const collapseHeader = document.getElementById("collapseHeader");
    const collapseChev = document.getElementById("collapseChev");

    const scriptCollapse = document.getElementById("scriptCollapse");
    const scriptHeader = document.getElementById("scriptHeader");
    const scriptChev = document.getElementById("scriptChev");
    const scriptText = document.getElementById("scriptText");
    const lockoutText = document.getElementById("lockoutText");
    const scriptReadingLine = document.getElementById("scriptReadingLine");
    const lockoutReadingLine = document.getElementById("lockoutReadingLine");
    const setWpmBtn = document.getElementById("setWpmBtn");

    const wpmModal = document.getElementById("wpmModal");
    const wpmInput = document.getElementById("wpmInput");
    const wpmCancelBtn = document.getElementById("wpmCancelBtn");
    const wpmSaveBtn = document.getElementById("wpmSaveBtn");

    const regionsModal = document.getElementById("regionsModal");
    const manageRegionsBtn = document.getElementById("manageRegionsBtn");
    const regionsCloseBtn = document.getElementById("regionsCloseBtn");
    const regionsAddBtn = document.getElementById("regionsAddBtn");
    const regionsList = document.getElementById("regionsList");
    const newRegionId = document.getElementById("newRegionId");
    const newRegionLabel = document.getElementById("newRegionLabel");

    const cadBtn = document.getElementById("cadBtn");
    const quickmapBtn = document.getElementById("quickmapBtn");

    const gmapsFrame = document.getElementById("gmapsFrame");
    const cadFrame = document.getElementById("cadFrame");
    const quickmapFrame = document.getElementById("quickmapFrame");

    let regions = loadRegions();
    let routes = loadRoutes() ?? defaultRoutes();

    let currentRoute = null;
    let currentReversed = false;
    let activeFilter = "ALL";

    let wpm = loadWpm();

    // CAD persistence: separate iframe stays loaded (hidden via display none).
    let cadVisible = false;
    let cadInitialized = false;
    let quickmapVisible = false;
    let quickmapInitialized = false;

    /* ---------- Storage: basic helpers ---------- */
    function loadText(key, fallback = "") {
      try {
        const v = localStorage.getItem(key);
        return v == null ? fallback : v;
      } catch {
        return fallback;
      }
    }
    function saveText(key, value) {
      localStorage.setItem(key, value);
    }

    /* ---------- Storage: Routes ---------- */
    function loadRoutes() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return null;
        return parsed;
      } catch {
        return null;
      }
    }
    function saveRoutes() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(routes));
    }

    /* ---------- Storage: Regions ---------- */
    function loadRegions() {
      try {
        const raw = localStorage.getItem(REGIONS_KEY);
        if (!raw) return defaultRegions();
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return defaultRegions();
        const cleaned = parsed
          .filter(r => r && typeof r.id === "string" && typeof r.label === "string")
          .map(r => ({ id: r.id.trim(), label: r.label.trim() }))
          .filter(r => r.id && r.label);
        return cleaned.length ? cleaned : defaultRegions();
      } catch {
        return defaultRegions();
      }
    }
    function saveRegions() {
      localStorage.setItem(REGIONS_KEY, JSON.stringify(regions));
    }

    /* ---------- Storage: WPM ---------- */
    function loadWpm() {
      try {
        const raw = localStorage.getItem(WPM_KEY);
        const n = Number(raw);
        if (!Number.isFinite(n) || n <= 30) return 180;
        return Math.round(n);
      } catch {
        return 180;
      }
    }
    function saveWpm(n) {
      localStorage.setItem(WPM_KEY, String(n));
    }

    /* ---------- URL builders ---------- */
    const TRAVELMODE = "driving";
    const DIRFLG = "d";
    function buildEmbedUrl(origin, destination) {
      const o = encodeURIComponent(origin.trim());
      const d = encodeURIComponent(destination.trim());
      return `https://www.google.com/maps?saddr=${o}&daddr=${d}&dirflg=${DIRFLG}&output=embed`;
    }
    function buildExternalDirUrl(origin, destination) {
      const o = encodeURIComponent(origin.trim());
      const d = encodeURIComponent(destination.trim());
      return `https://www.google.com/maps/dir/?api=1&origin=${o}&destination=${d}&travelmode=${TRAVELMODE}`;
    }

    /* ---------- Collapsible ---------- */
    function setCollapse(el, headerEl, chevEl, open) {
      el.classList.toggle("open", open);
      headerEl.setAttribute("aria-expanded", String(open));
      chevEl.textContent = open ? "Hide" : "Show";
    }

    setCollapse(addCollapse, collapseHeader, collapseChev, false);
    function toggleAddCollapse() {
      setCollapse(addCollapse, collapseHeader, collapseChev, !addCollapse.classList.contains("open"));
    }
    collapseHeader.addEventListener("click", toggleAddCollapse);
    collapseHeader.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggleAddCollapse(); }
    });

    setCollapse(scriptCollapse, scriptHeader, scriptChev, false);
    function toggleScriptCollapse() {
      setCollapse(scriptCollapse, scriptHeader, scriptChev, !scriptCollapse.classList.contains("open"));
    }
    scriptHeader.addEventListener("click", toggleScriptCollapse);
    scriptHeader.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggleScriptCollapse(); }
    });

    /* ---------- Script behavior ---------- */
    scriptText.value = loadText(SCRIPT_KEY, "");
    lockoutText.value = loadText(LOCKOUT_KEY, "");

    scriptText.addEventListener("input", () => {
      saveText(SCRIPT_KEY, scriptText.value);
      updateReadingLines();
    });
    lockoutText.addEventListener("input", () => {
      saveText(LOCKOUT_KEY, lockoutText.value);
      updateReadingLines();
    });

    function countWords(str) {
      const t = (str || "").trim();
      if (!t) return 0;
      return t.split(/\s+/).filter(Boolean).length;
    }
    function formatMmSs(totalSeconds) {
      const s = Math.max(0, Math.round(totalSeconds));
      const m = Math.floor(s / 60);
      const r = s % 60;
      return `${m}:${String(r).padStart(2, "0")}`;
    }
    function estimateSeconds(words) {
      return wpm > 0 ? (words / wpm) * 60 : 0;
    }
    function updateReadingLines() {
      const scriptWords = countWords(scriptText.value);
      const lockWords = countWords(lockoutText.value);
      scriptReadingLine.textContent = `WPM: ${wpm} | Script words: ${scriptWords} | Reading time: ${formatMmSs(estimateSeconds(scriptWords))}`;
      lockoutReadingLine.textContent = `Lockout words: ${lockWords} | Reading time: ${formatMmSs(estimateSeconds(lockWords))}`;
    }
    updateReadingLines();

    /* ---------- Modals ---------- */
    function openModal(el) { el.classList.add("open"); }
    function closeModal(el) { el.classList.remove("open"); }
    function backdropCloseHandler(modalEl) {
      modalEl.addEventListener("click", (e) => {
        if (e.target === modalEl) closeModal(modalEl);
      });
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modalEl.classList.contains("open")) closeModal(modalEl);
      });
    }
    backdropCloseHandler(wpmModal);
    backdropCloseHandler(regionsModal);

    setWpmBtn.addEventListener("click", () => {
      wpmInput.value = String(wpm);
      openModal(wpmModal);
      setTimeout(() => wpmInput.focus(), 0);
    });
    wpmCancelBtn.addEventListener("click", () => closeModal(wpmModal));
    wpmSaveBtn.addEventListener("click", () => {
      const n = Number(String(wpmInput.value).trim());
      if (!Number.isFinite(n) || n < 30 || n > 800) {
        alert("Enter a valid WPM between 30 and 800.");
        return;
      }
      wpm = Math.round(n);
      saveWpm(wpm);
      updateReadingLines();
      closeModal(wpmModal);
    });

    /* ---------- Regions ---------- */
    const regionSelect = document.getElementById("region");

    function normalizeRegionId(id) {
      return String(id || "").trim();
    }

    function ensureRoutesUseValidRegions() {
      const valid = new Set(regions.map(r => r.id));
      const before = routes.length;
      routes = routes.filter(rt => valid.has(normalizeRegionId(rt.region || "")));
      if (routes.length !== before) saveRoutes();
    }

    function renderRegionSelect() {
      regionSelect.innerHTML = "";
      for (const r of regions) {
        const opt = document.createElement("option");
        opt.value = r.id;
        opt.textContent = r.label;
        regionSelect.appendChild(opt);
      }
      if (!regions.find(x => x.id === regionSelect.value)) {
        regionSelect.value = regions[0]?.id || "LA";
      }
    }

    function renderFilters() {
      filterBar.innerHTML = "";

      const allBtn = document.createElement("button");
      allBtn.type = "button";
      allBtn.dataset.filter = "ALL";
      allBtn.textContent = "All";
      allBtn.classList.toggle("active", activeFilter === "ALL");
      filterBar.appendChild(allBtn);

      for (const r of regions) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.dataset.filter = r.id;
        btn.textContent = r.label;
        btn.classList.toggle("active", activeFilter === r.id);
        filterBar.appendChild(btn);
      }
    }

    function setActiveFilter(filter) {
      activeFilter = filter;
      renderFilters();
      renderList();
    }

    filterBar.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-filter]");
      if (!btn) return;
      setActiveFilter(btn.dataset.filter);
    });

    function openRegionsManager() {
      renderRegionsManagerList();
      openModal(regionsModal);
    }

    function renderRegionsManagerList() {
      regionsList.innerHTML = "";
      regions.forEach((r) => {
        const row = document.createElement("div");
        row.className = "region-row";
        row.style.marginBottom = "8px";

        const left = document.createElement("div");
        left.style.flex = "1";

        const pill = document.createElement("span");
        pill.className = "pill";
        pill.textContent = r.id;

        const name = document.createElement("span");
        name.style.marginLeft = "8px";
        name.textContent = r.label;

        left.appendChild(pill);
        left.appendChild(name);

        const del = document.createElement("button");
        del.type = "button";
        del.className = "danger";
        del.textContent = "Delete";
        del.disabled = regions.length <= 1;
        del.addEventListener("click", () => {
          if (regions.length <= 1) return;

          const ok = confirm(
            `Delete region "${r.label}" (${r.id})?\n\nThis will also delete all routes in this region.`
          );
          if (!ok) return;

          const removedId = r.id;
          const removedRouteIds = new Set(routes.filter(rt => (rt.region || "") === removedId).map(rt => rt.id));

          routes = routes.filter(rt => (rt.region || "") !== removedId);
          saveRoutes();

          if (currentRoute && removedRouteIds.has(currentRoute.id)) {
            clearCurrent();
          }

          regions = regions.filter(x => x.id !== removedId);
          saveRegions();

          if (activeFilter === removedId) activeFilter = "ALL";

          renderRegionSelect();
          renderFilters();
          renderList();
          renderRegionsManagerList();
        });

        row.appendChild(left);
        row.appendChild(del);
        regionsList.appendChild(row);
      });
    }

    manageRegionsBtn.addEventListener("click", openRegionsManager);
    regionsCloseBtn.addEventListener("click", () => closeModal(regionsModal));

    regionsAddBtn.addEventListener("click", () => {
      const id = normalizeRegionId(newRegionId.value).replace(/\s+/g, "");
      const label = String(newRegionLabel.value || "").trim();

      if (!id || !label) {
        alert("Enter both a code and a name.");
        return;
      }
      if (!/^[A-Za-z0-9_:-]+$/.test(id)) {
        alert("Region code can only use letters/numbers and _:-");
        return;
      }
      if (regions.some(r => r.id.toLowerCase() === id.toLowerCase())) {
        alert("That region code already exists.");
        return;
      }

      regions.push({ id, label });
      saveRegions();

      newRegionId.value = "";
      newRegionLabel.value = "";

      renderRegionSelect();
      renderFilters();
      renderList();
      renderRegionsManagerList();
    });

    /* ---------- Filtering ---------- */
    function getFilteredRoutes() {
      if (activeFilter === "ALL") return routes;
      return routes.filter(r => (r.region || "") === activeFilter);
    }

    /* ---------- Drag / Drop ---------- */
    let draggedId = null;
    function indexById(id) { return routes.findIndex(r => r.id === id); }

    function moveRouteBefore(dragId, targetId) {
      if (!dragId || !targetId || dragId === targetId) return;
      const from = indexById(dragId);
      const to = indexById(targetId);
      if (from < 0 || to < 0) return;

      const item = routes[from];
      routes.splice(from, 1);
      const newIndex = from < to ? to - 1 : to;
      routes.splice(newIndex, 0, item);

      saveRoutes();
      renderList();
    }

    /* ---------- Maps + CAD toggle ---------- */
    function showGmaps() {
      cadVisible = false;
      quickmapVisible = false;
      cadBtn.classList.remove("active-toggle");
      quickmapBtn.classList.remove("active-toggle");
      gmapsFrame.style.display = "block";
      cadFrame.style.display = "none";
      quickmapFrame.style.display = "none";

      const hasRoute = !!currentRoute;
      openExternalBtn.disabled = !hasRoute;
      reverseCurrentBtn.disabled = !hasRoute;
    }

    function showCad() {
      cadVisible = true;
      quickmapVisible = false;
      cadBtn.classList.add("active-toggle");
      quickmapBtn.classList.remove("active-toggle");
      gmapsFrame.style.display = "none";
      cadFrame.style.display = "block";
      quickmapFrame.style.display = "none";

      if (!cadInitialized) {
        cadFrame.src = CAD_BASE;
        cadInitialized = true;
      }

      openExternalBtn.disabled = true;
      reverseCurrentBtn.disabled = true;
    }

    function showQuickmap() {
      cadVisible = false;
      quickmapVisible = true;
      cadBtn.classList.remove("active-toggle");
      quickmapBtn.classList.add("active-toggle");
      gmapsFrame.style.display = "none";
      cadFrame.style.display = "none";
      quickmapFrame.style.display = "block";

      if (!quickmapInitialized) {
        quickmapFrame.src = QUICKMAP_URL;
        quickmapInitialized = true;
      }

      openExternalBtn.disabled = true;
      reverseCurrentBtn.disabled = true;
    }

    cadBtn.addEventListener("click", () => {
      if (cadVisible) showGmaps();
      else showCad();
    });

    quickmapBtn.addEventListener("click", () => {
      if (quickmapVisible) showGmaps();
      else showQuickmap();
    });

    /* ---------- Current route selection ---------- */
    function setCurrent(route, reversed = false) {
      if (!route) return;

      currentRoute = route;
      currentReversed = reversed;

      const o = reversed ? route.destination : route.origin;
      const d = reversed ? route.origin : route.destination;

      gmapsFrame.src = buildEmbedUrl(o, d);

      const regionLabel = regions.find(r => r.id === (route.region || ""))?.label || route.region || "";
      currentLabel.textContent = `${route.name}${regionLabel ? " | " + regionLabel : ""}${reversed ? " (reversed)" : ""}`;

      if (!cadVisible) {
        openExternalBtn.disabled = false;
        reverseCurrentBtn.disabled = false;
      }
    }

    function clearCurrent() {
      currentRoute = null;
      currentReversed = false;
      currentLabel.textContent = "";
      if (!cadVisible) {
        openExternalBtn.disabled = true;
        reverseCurrentBtn.disabled = true;
      }
      gmapsFrame.src = "about:blank";
    }

    openExternalBtn.addEventListener("click", () => {
      if (!currentRoute) return;
      const o = currentReversed ? currentRoute.destination : currentRoute.origin;
      const d = currentReversed ? currentRoute.origin : currentRoute.destination;
      window.open(buildExternalDirUrl(o, d), "_blank", "noopener,noreferrer");
    });

    reverseCurrentBtn.addEventListener("click", () => {
      if (!currentRoute) return;
      setCurrent(currentRoute, !currentReversed);
    });

    /* ---------- Render list ---------- */
    function renderList() {
      const list = getFilteredRoutes();
      countLabel.textContent = `${list.length} shown / ${routes.length} total`;

      routeListEl.innerHTML = "";

      for (const r of list) {
        const card = document.createElement("div");
        card.className = "card";
        card.draggable = true;

        const top = document.createElement("div");
        top.className = "top";

        const left = document.createElement("div");
        left.style.flex = "1";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = r.name;

        const regionLabel = regions.find(x => x.id === (r.region || ""))?.label || r.region || "";
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = `${regionLabel ? regionLabel + " | " : ""}${r.origin} → ${r.destination}`;

        left.appendChild(name);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.className = "card-actions";

        const go = document.createElement("button");
        go.type = "button";
        go.textContent = "Show";
        go.addEventListener("click", () => {
          showGmaps();
          setCurrent(r, false);
        });

        const rev = document.createElement("button");
        rev.type = "button";
        rev.textContent = "Reverse";
        rev.addEventListener("click", () => {
          showGmaps();
          setCurrent(r, true);
        });

        const del = document.createElement("button");
        del.type = "button";
        del.className = "danger-x";
        del.title = "Delete route";
        del.textContent = "✕";
        del.addEventListener("click", () => {
          const ok = confirm(`Delete route?\n\n${r.name}`);
          if (!ok) return;

          routes = routes.filter(x => x.id !== r.id);
          saveRoutes();

          if (currentRoute && currentRoute.id === r.id) clearCurrent();
          renderList();
        });

        right.appendChild(go);
        right.appendChild(rev);
        right.appendChild(del);

        top.appendChild(left);
        top.appendChild(right);

        card.appendChild(top);

        // Drag events
        card.addEventListener("dragstart", (e) => {
          draggedId = r.id;
          card.classList.add("dragging");
          e.dataTransfer.effectAllowed = "move";
        });
        card.addEventListener("dragend", () => {
          draggedId = null;
          card.classList.remove("dragging");
          for (const el of routeListEl.querySelectorAll(".drop-hint")) el.classList.remove("drop-hint");
        });
        card.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.currentTarget.classList.add("drop-hint");
          e.dataTransfer.dropEffect = "move";
        });
        card.addEventListener("dragleave", (e) => {
          e.currentTarget.classList.remove("drop-hint");
        });
        card.addEventListener("drop", (e) => {
          e.preventDefault();
          e.currentTarget.classList.remove("drop-hint");
          moveRouteBefore(draggedId, r.id);
        });

        routeListEl.appendChild(card);
      }
    }

    /* ---------- Add route ---------- */
    routeForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const fd = new FormData(routeForm);
      const name = String(fd.get("name") || "").trim();
      const region = String(fd.get("region") || "").trim();
      const origin = String(fd.get("origin") || "").trim();
      const destination = String(fd.get("destination") || "").trim();

      if (!name || !origin || !destination) return;

      const valid = new Set(regions.map(r => r.id));
      if (!valid.has(region)) {
        alert("Select a valid region.");
        return;
      }

      routes.unshift({
        id: crypto.randomUUID(),
        region,
        name,
        origin,
        destination,
      });

      saveRoutes();
      routeForm.reset();
      renderRegionSelect();
      renderList();
    });

    /* ---------- Export / Import / Defaults ---------- */
    function escXml(s) {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll("\"","&quot;")
        .replaceAll("'","&apos;");
    }

    function datasetToXml(regs, rts) {
      let xml = `<?xml version="1.0" encoding="UTF-8"?>\n<data>\n`;

      xml += `  <regions>\n`;
      for (const r of regs) {
        xml += `    <region>\n`;
        xml += `      <id>${escXml(r.id || "")}</id>\n`;
        xml += `      <label>${escXml(r.label || "")}</label>\n`;
        xml += `    </region>\n`;
      }
      xml += `  </regions>\n`;

      xml += `  <routes>\n`;
      for (const r of rts) {
        xml += `    <route>\n`;
        xml += `      <id>${escXml(r.id || "")}</id>\n`;
        xml += `      <region>${escXml(r.region || "")}</region>\n`;
        xml += `      <name>${escXml(r.name || "")}</name>\n`;
        xml += `      <origin>${escXml(r.origin || "")}</origin>\n`;
        xml += `      <destination>${escXml(r.destination || "")}</destination>\n`;
        xml += `    </route>\n`;
      }
      xml += `  </routes>\n`;

      xml += `</data>\n`;
      return xml;
    }

    function downloadText(filename, text) {
      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    exportRoutesBtn.addEventListener("click", () => {
      const xml = datasetToXml(regions, routes);
      const ts = new Date().toISOString().slice(0,19).replaceAll(":","-");
      downloadText(`routes-${ts}.xml`, xml);
    });

    importRoutesBtn.addEventListener("click", () => importFile.click());

    importFile.addEventListener("change", async () => {
      const f = importFile.files?.[0];
      importFile.value = "";
      if (!f) return;

      const text = await f.text();
      try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, "text/xml");

        // Support both:
        //  - new format: <data><regions>...<routes>...</routes></data>
        //  - old format: <routes><route>...</route></routes> (routes only)
        const regionNodes = Array.from(doc.querySelectorAll("regions > region"));
        const routeNodesNew = Array.from(doc.querySelectorAll("routes > route"));
        const routeNodesOld = Array.from(doc.querySelectorAll("routes > route")).length ? [] : Array.from(doc.querySelectorAll("routes > route")); // unused, kept harmless
        const routeNodesLegacy = Array.from(doc.querySelectorAll("routes > route"));
        const legacyRoutesOnlyNodes = Array.from(doc.querySelectorAll("routes > route"));
        const routesOnlyNodes = Array.from(doc.querySelectorAll("routes > route"));
        const reallyOldNodes = Array.from(doc.querySelectorAll("routes > route"));

        // Actually detect old format correctly
        const oldFormatRouteNodes = Array.from(doc.querySelectorAll("routes > route"));
        const oldTopLevelRoutes = Array.from(doc.querySelectorAll("routes > route"));
        // If they exported old earlier version here: <routes><route>...</route></routes>
        const routesOnly = Array.from(doc.querySelectorAll("routes > route")).length === 0
          ? Array.from(doc.querySelectorAll("routes > route"))
          : [];

        // Proper detection:
        const newRoutesNodes = Array.from(doc.querySelectorAll("data > routes > route, routes > route"));
        const isNewDataset = doc.querySelector("data > regions") != null || doc.querySelector("regions") != null;

        // Parse regions if present
        let importedRegions = null;
        if (isNewDataset && regionNodes.length) {
          importedRegions = regionNodes
            .map(n => ({
              id: (n.querySelector("id")?.textContent || "").trim(),
              label: (n.querySelector("label")?.textContent || "").trim(),
            }))
            .filter(r => r.id && r.label);
          if (!importedRegions.length) importedRegions = null;
        }

        // Fallback if regions missing: keep current regions
        const workingRegions = importedRegions ?? regions;

        const valid = new Set(workingRegions.map(r => r.id));

        // Parse routes: accept either <data><routes> OR legacy <routes> root
        const routeNodes = Array.from(doc.querySelectorAll("data > routes > route"));
        const legacyRootNodes = Array.from(doc.querySelectorAll("routes > route"));
        const finalRouteNodes = routeNodes.length ? routeNodes : legacyRootNodes;

        if (!finalRouteNodes.length) throw new Error("No <route> nodes found.");

        const importedRoutes = finalRouteNodes.map(n => ({
          id: (n.querySelector("id")?.textContent || crypto.randomUUID()).trim(),
          region: (n.querySelector("region")?.textContent || "").trim(),
          name: (n.querySelector("name")?.textContent || "").trim(),
          origin: (n.querySelector("origin")?.textContent || "").trim(),
          destination: (n.querySelector("destination")?.textContent || "").trim(),
        }))
        .filter(r => r.name && r.origin && r.destination && valid.has(r.region));

        if (!importedRoutes.length) {
          throw new Error("Imported file had no usable routes (or regions didn't match).");
        }

        // Commit import
        regions = workingRegions;
        routes = importedRoutes;

        saveRegions();
        saveRoutes();

        // UI refresh
        if (activeFilter !== "ALL" && !valid.has(activeFilter)) activeFilter = "ALL";
        clearCurrent();
        renderRegionSelect();
        renderFilters();
        renderList();

        alert(`Imported ${routes.length} routes${importedRegions ? " and regions" : ""}.`);
      } catch (err) {
        alert(`Import failed: ${err?.message || err}`);
      }
    });

    loadDefaultsBtn.addEventListener("click", () => {
      const ok = confirm("Replace your current routes AND regions with the built-in defaults?");
      if (!ok) return;

      regions = defaultRegions();
      routes = defaultRoutes();

      saveRegions();
      saveRoutes();

      activeFilter = "ALL";
      clearCurrent();
      renderRegionSelect();
      renderFilters();
      renderList();
    });

    resetBtn.addEventListener("click", () => {
      routeForm.reset();
      renderRegionSelect();
    });

    /* ---------- Left pane resize (saved) ---------- */
    function loadLeftWidth() {
      try {
        const raw = localStorage.getItem(LEFT_WIDTH_KEY);
        const n = Number(raw);
        if (!Number.isFinite(n)) return null;
        return Math.max(240, Math.min(n, window.innerWidth * 0.8));
      } catch {
        return null;
      }
    }
    function saveLeftWidth(px) {
      localStorage.setItem(LEFT_WIDTH_KEY, String(px));
    }

    const savedWidth = loadLeftWidth();
    if (savedWidth) leftPane.style.width = `${savedWidth}px`;

    let resizing = false;
    splitter.addEventListener("pointerdown", (e) => {
      resizing = true;
      splitter.setPointerCapture(e.pointerId);
    });
    splitter.addEventListener("pointermove", (e) => {
      if (!resizing) return;
      const rect = document.body.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const px = Math.max(240, Math.min(x, window.innerWidth * 0.8));
      leftPane.style.width = `${px}px`;
      saveLeftWidth(px);
    });
    splitter.addEventListener("pointerup", (e) => {
      resizing = false;
      splitter.releasePointerCapture(e.pointerId);
    });

    /* ---------- Init ---------- */
    function init() {
      renderRegionSelect();
      renderFilters();
      ensureRoutesUseValidRegions();
      saveRoutes();
      renderList();

      // start on gmaps
      gmapsFrame.src = "about:blank";
      showGmaps();
    }

    init();
  </script>
</body>
</html>
